#!/bin/sh -x
#
#  Authors:
#    Christian Schulte <schulte@ps.uni-sb.de>
# 
#  Copyright:
#    Christian Schulte, 1998
# 
#  Last change:
#    $Date$ by $Author$
#    $Revision$
# 
#  This file is part of Mozart, an implementation 
#  of Oz 3:
#     http://mozart.ps.uni-sb.de
# 
#  See the file "LICENSE" or
#     http://mozart.ps.uni-sb.de/LICENSE.html
#  for information on usage and redistribution 
#  of this file, and for a DISCLAIMER OF ALL 
#  WARRANTIES.
#

RPMROOT=/usr/src/redhat
RPMSRC=$RPMROOT/SOURCES
RPMSPEC=$RPMROOT/SPECS
TMPDIR=/tmp

#
# Dinf destination dir
#
if test $# -lt 3
then
   echo "usage: create-rpm <src-tar> <doc-tar> <dst-dir>" 1>&2;
   exit 1;
fi
SRCTAR=$1
DOCTAR=$2
DSTDIR=$3

#
# Find version
#

VERSION=`(echo ${SRCTAR} | sed 's/.*mozart-\(.*-.*\)-src.tar.gz/\1/')`
BUILD=1


#
# Build sh files
#

cd $TMPDIR

cat > oz.sh <<EOF
export OZHOME=/usr/local/mozart
export PATH=\${OZHOME}/bin:\${PATH}
EOF

cat > oz.csh <<EOF
setenv OZHOME /usr/local/mozart
setenv PATH \${OZHOME}/bin:\${PATH}
EOF

chmod a+x oz.sh oz.csh
tar cf - oz.csh oz.sh | gzip -9 -c > ${RPMSRC}/mozart-profiles.tar.gz
rm -f oz.sh oz.csh

cp ${SRCTAR} ${DOCTAR} ${RPMSRC}

# Generate redhat spec file
cd $TMPDIR
cat > ${RPMSPEC}/mozart-$VERSION-$BUILD.spec <<EOF
# Spec file for Mozart, an efficient and distributed implementation of Oz
# Author: Christian Schulte, 1998
# Copyright: Christian Schulte, 1998
Name: mozart
Version: ${VERSION}
Release: ${BUILD}
Summary: Mozart, an efficient and distributed implementation of Oz
Copyright: More liberal than GPL (see LICENSE)
Vendor: DFKI GmbH
Url: http://mozart.ps.uni-sb.de/
Group: Development/Languages
Packager: Christian Schulte <schulte@ps.uni-sb.de>

Source0: mozart-${VERSION}-src.tar.gz
Source1: mozart-${VERSION}-doc.tar.gz
Source2: mozart-profiles.tar.gz

BuildRoot: /var/tmp/mozart-${VERSION}

%description
Mozart is an efficient and distributed implementation of Oz.

Mozart is jointly developed by DFKI and SICS.

%package doc
Summary: Mozart documentation
Group: Development/Languages

%description doc
Mozart is an efficient and distributed implementation of Oz.

Documentation

%package contrib
Summary: Mozart contributions
Group: Development/Languages

%description contrib
Mozart is an efficient and distributed implementation of Oz.

Contributed stuff (gdbm, regex, ...)

%prep
%setup -c -a 1
%setup -c -D -T -a 2

%build
cd mozart
CFLAGS="-O0" CXXFLAGS="-O0" ./configure --prefix=\$RPM_BUILD_ROOT/usr/local/mozart

make

%install
PREFIX=\$RPM_BUILD_ROOT/usr/local/mozart
rm -rf \$PREFIX
mkdir -p \$PREFIX
# install docs
cp -a doc \$PREFIX
# Generic install
(cd mozart && make install)

# With this installation stripping works fine

%ifarch i386

(cd \$PREFIX/platform/linux-i486 && \
	strip *.exe && \
	strip *.so )

%endif

# config files
mkdir -p \$RPM_BUILD_ROOT/etc/profile.d
cp -a oz.sh oz.csh \$RPM_BUILD_ROOT/etc/profile.d

%clean
rm -rf \$RPM_BUILD_ROOT
%files
%doc mozart/README mozart/LICENSE mozart/LICENSE.html
%config /etc/profile.d/oz.sh
%config /etc/profile.d/oz.csh
/usr/local/mozart/LICENSE
/usr/local/mozart/LICENSE.html
/usr/local/mozart/bin
/usr/local/mozart/cache
/usr/local/mozart/include
/usr/local/mozart/platform
/usr/local/mozart/share
%files doc
/usr/local/mozart/doc
/usr/local/mozart/examples
%files contrib
/usr/local/mozart/contrib
EOF

#
# No we have all what we need, go and build rpms
#

rpm -ba --clean ${RPMSPEC}/mozart-$VERSION-$BUILD.spec
rm -f ${RPMSPEC}/mozart-$VERSION-$BUILD.spec
rm -f ${RPMSRC}/mozart-$VERSION.tar.gz
rm -f ${RPMSRC}/mozart-doc-$VERSION.tar.gz
rm -f ${RPMSRC}/mozart-profiles.tar.gz

#
# Move the created rpms to destination
#

mv ${RPMROOT}/RPMS/i386/mozart-$VERSION-$BUILD.i386.rpm ${DESTDIR}
mv ${RPMROOT}/SRPMS/mozart-$VERSION-$BUILD.src.rpm ${DESTDIR}
