#!/bin/sh
# Script that configures the environment to
# start lemacs for a standalone version of Oz
# MUST reside in <oz dist dir>/bin

#set -vx

# where Oz resides:

howcalled=$0

if [ ${OZHOME-xx} = xx ]
then
  OZHOME =`dirname \`dirname $howcalled\``
  echo "Setting Oz installation directory to: $OZHOME"
  export OZHOME
fi

# determine machine architecture
if [ ${OZARCH-xx} = xx ]
then
  if   [ -f /usr/bin/arch ]; then OZARCH=`/usr/bin/arch`
  elif [ -f /bin/machine ]; then OZARCH=`/bin/machine`
  else echo 1>&2 "error: cannot determine machine type"; exit 1
  fi
fi
export OZARCH
#echo "OZARCH = $OZARCH"


: ${OZCOMPILER:=$OZHOME/bin/$OZARCH/oz.compiler.bin}
#echo "OZCOMPILER = $OZCOMPILER"

: ${OZMACHINE:=$OZHOME/bin/$OZARCH/oz.machine.bin}
#echo "OZMACHINE = $OZMACHINE"


# set OZPATH & PATH
if [ ${OZ_PI-xx} = xx ]; then

	# where Oz searches for files:
	: ${OZPATH:=.}
	OZPATH=${OZPATH}:${OZHOME}/lib:${OZHOME}/lib/${OZARCH}:${OZHOME}/demo
	export OZPATH
#echo "OZPATH = $OZPATH"
	# increment path
	PATH=${PATH}:${OZHOME}/bin:${OZHOME}/bin/${OZARCH}
	export PATH
#echo "PATH = $PATH"
        OZ_PI=1
	export OZ_PI
fi

# load fonts
if [ -d ${OZHOME}/lib/fonts ]; then 
   xset +fp ${OZHOME}/lib/fonts
fi


# setting line editor
ILE=$OZHOME/bin/$OZARCH/ile
if [ ! -f $ILE -o $TERM = emacs ]; then
   ILE=""  # running under emacs
fi


cmd=`basename $howcalled`

case "$cmd" in

   oz) 
	# where is lucid emacs?
	if [ ${OZEMACS-0} = 0 ]; then
	  if [ -f ${OZHOME}/lemacs/lemacs ]; then
	     OZEMACS=${OZHOME}/lemacs/lemacs
	  else

	     echo -n "checking for emacs: "
	     IFS="${IFS=   }"; saveifs="$IFS"; IFS="$IFS:"
             for name in lemacs emacs; do
	       for dir in $PATH; do
		 test -z "$dir" && dir=.
	    	 if test -f $dir/$name; then
	      	   # Not all systems have dirname.
	           OZEMACS=$dir/$name
	      	   break 2
		 fi
	       done
             done
	     IFS="$saveifs"
	     if [ ${OZEMACS-0} = 0 ]; then
		echo "not found" 1>&2
		echo "Try setting environment variable OZEMACS" 1>&2
		exit 1
	     fi
	     echo "${OZEMACS}"

	  fi
	fi

	exec $OZEMACS -l $OZHOME/lib/elisp/ozstartup.el $*
   ;;

   oz.compiler)


       if [ $TERM = "emacs" ]; then
          exec $OZCOMPILER +E `echo $* |  sed -e 's/-/+/g'`
       else
          exec xterm -name "OzCompiler" \
               -T "Oz Compiler Input Window" \
	       -e $ILE $OZCOMPILER `echo $* |  sed -e 's/-/+/g'`
       fi
   ;;

   oz.machine)


      if [ $TERM = "emacs" ]; then
        exec $OZMACHINE -E $*
      else
        xterm -title 'Oz Machine' -e $OZMACHINE $* > /dev/null 2>&1 &
      fi
      exit 0
   ;;

   oz-)
	exec $ILE $OZCOMPILER $*
   ;;

   *)
       echo "Unknown invocation of Oz via '$cmd'" 1>&2
       exit 1
   ;;
esac


