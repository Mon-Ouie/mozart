BUILDTOP        = @BUILDTOP@
prefix          = @prefix@
PLATFORM        = @PLATFORM@
PACKAGE         = @PACKAGE@
PROTOCOL        = @PROTOCOL@
DIR_LOAD        = $(prefix)/cache/$(PROTOCOL)/$(PACKAGE)
DIR_DLOAD       = $(prefix)/platform/$(PLATFORM)/cache/$(PACKAGE)

OZBATCH         = @OZBATCH@
OZDYNLD         = @OZDYNLD@
MKINSTALLDIRS   = @MKINSTALLDIRS@

CXX             = @CXX@
CPPFLAGS        = -I../../platform/emulator @CPPFLAGS@
CXXFLAGS        = $(CFLAGS)
LDFLAGS         = @LDFLAGS@
LIBS            = @LIBS@

INSTALL         = @INSTALL@
INSTALL_DIR     = $(MKINSTALLDIRS)
INSTALL_BIN     = $(INSTALL) -m 555
INSTALL_LIB     = $(INSTALL) -m 444

FILES_LOAD      = gdbm.ozc
FILES_DLOAD     = gdbm.so

LIB_FILES_LOAD  = $(addprefix $(DIR_LOAD)/,$(FILES_LOAD))
LIB_FILES_DLOAD = $(addprefix $(DIR_DLOAD)/,$(FILES_DLOAD))

.PHONY: all install install-load install-dload \
        clean realclean veryclean distclean

all: gdbm.so gdbm.ozc

install: install-load install-dload
install-load:   $(DIR_LOAD)  $(LIB_FILES_LOAD)
install-dload:  $(DIR_DLOAD) $(LIB_FILES_DLOAD)

$(DIR_LOAD) $(DIR_DLOAD):
        $(INSTALL_DIR) $@

$(subst %,\%,$(DIR_LOAD))/%: %
        $(INSTALL_LIB) $< $@

$(subst %,\%,$(DIR_DLOAD))/%: %
        $(INSTALL_LIB) $< $@

gdbm.o: gdbm.cc
        $(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $<

gdbm.so: gdbm.o
        $(OZDYNLD) -o gdbm.so gdbm.o $(LDFLAGS) $(LIBS)

gdbm.ozc: gdbm.oz
        $(OZBATCH) -c gdbm.oz

clean realclean veryclean:
        -$(RM) *~ *.bak *.o *.so *.ozc *.oz

distclean: clean
        -$(RM) config.* Makefile

include ../../share/Makefile.boot
