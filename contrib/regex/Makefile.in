BUILDTOP        = @BUILDTOP@
prefix          = @prefix@
PLATFORM        = @PLATFORM@
PACKAGE         = @PACKAGE@
PROTOCOL        = @PROTOCOL@
DIR_LOAD        = $(prefix)/cache/$(PROTOCOL)/$(PACKAGE)
DIR_DLOAD       = $(prefix)/platform/$(PLATFORM)/cache/$(PACKAGE)

OZC             = @OZC@
COMPILE         = $(OZC) -c
OZDYNLD         = @OZDYNLD@
MKINSTALLDIRS   = @MKINSTALLDIRS@

CXX             = @CXX@
CXXFLAGS        = @CXXFLAGS@
CPPBASE         = -I../../platform/emulator -I$(prefix)/include
CPPFLAGS        = @CPPFLAGS@ $(CPPBASE)
LDFLAGS         = @LDFLAGS@
LIBS            = @LIBS@ -lc

INSTALL         = @INSTALL@
INSTALL_DIR     = $(MKINSTALLDIRS)
INSTALL_BIN     = $(INSTALL) -m 555
INSTALL_LIB     = $(INSTALL) -m 444

POSIX_LOAD      = posix.ozf
POSIX_DLOAD     = posix.so

ALL_LOAD        = $(POSIX_LOAD)
ALL_DLOAD       = $(POSIX_DLOAD)

LIB_POSIX_LOAD  = $(addprefix $(DIR_LOAD)/,$(POSIX_LOAD))
LIB_POSIX_DLOAD = $(addprefix $(DIR_DLOAD)/,$(POSIX_DLOAD))

.PHONY: all install install-load install-dload \
        posix install-posix install-posix-load install-posix-dload \
        clean veryclean distclean \
        bootstrap

all:    posix
posix:  $(POSIX_LOAD) $(POSIX_DLOAD)

install:        install-posix
install-load:   install-posix-load
install-dload:  install-posix-dload

install-posix:  install-posix-load install-posix-dload
install-posix-load:     $(DIR_LOAD)  $(LIB_POSIX_LOAD)
install-posix-dload:    $(DIR_DLOAD) $(LIB_POSIX_DLOAD)

$(DIR_LOAD) $(DIR_DLOAD):
        $(INSTALL_DIR) $@

$(subst %,\%,$(DIR_LOAD))/%: %
        $(INSTALL_LIB) $< $@

$(subst %,\%,$(DIR_DLOAD))/%: %
        $(INSTALL_LIB) $< $@

$(ALL_LOAD): %.ozf : %.oz
        $(COMPILE) $< -o $@

$(ALL_DLOAD): %.so : %.o
        $(OZDYNLD) -o $@ $< $(LDFLAGS) $(LIBS)

%.o: %.c
        $(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $<

clean veryclean:
        -$(RM) *~ *.ozf *.o *.so

distclean: clean
        -$(RM) config.* Makefile posix.oz

include ../../share/Makefile.boot

bootstrap: boot-all
