@SET_MAKE@
BUILDTOP        = @BUILDTOP@
SRCTOP          = @SRCTOP@
SRCDIR          = @srcdir@
VPATH           = @srcdir@
PREFIX          = @prefix@
PLATFORM        = @PLATFORM@
LIB_DIR         = $(PREFIX)/contrib
HOMEURL         = @HOMEURL@

OZC             = @OZC@
COMPILE         = $(OZC) -c
OZTOOL          = @OZTOOL@
CPPFLAGS        = -I$(SRCTOP)/platform/emulator \
                  -I$(BUILDTOP)/platform/emulator \
                  -I$(PREFIX)/include @CPPFLAGS@
CXXFLAGS        = @CXXFLAGS@
LDFLAGS         = @LDFLAGS@
LIBS            = @LIBS@

INSTALL         = @INSTALL@
INSTALL_DIR     = @INSTALL_DIR@
INSTALL_LIB     = $(INSTALL) -m 444


USECPLEX =
#USECPLEX = 1

OPTIMIZE = -O3
#OPTIMIZE = -g3 -DDEBUG_CHECK

LIBS     = -lc -lm -llpk-$(PLATFORM)
TARGETLIBPATH  = $(HOME)/.oz/cache/http/www.ps.uni-sb.de/~tmueller/mozart

CFLAGS  = -I/usr/local/oz/include
CFLAGS   += -I$(VPATH)/Lpsolve
CFLAGS   += -Wall -Wno-unused -Wno-reorder -Wno-uninitialized

LDFLAGS  = -L$(VPATH)


ifdef USECPLEX
CFLAGS   += -DINCLUDE_CPLEX -DALLWAYS_CLOSE_CPLEX
CFLAGS   += -I/linux/CPLEX
LDFLAGS  += -L/linux/CPLEX
LIBS     += -lcplex
endif

CXX     = $(OZTOOL) c++

DEPEND   = $(CXX) $(CFLAGS) -MM

#LD = ozdynld
LD = $(OZTOOL) ld


CPPSRCS  =      aux.cc \
                ri.cc \
                builtins.cc \
                propagators.cc \
                lp.cc

ifeq ($(PLATFORM), linux-i486)
CSRCS    = fpgetset.c sigfpe.c
CFLAGS   += -DLINUX_IEEE
endif

TARGZ    = ri.tar.gz

OBJS     = $(CPPSRCS:.cc=.o) $(CSRCS:.c=.o)

OZSRCS  =       RI.oz \
                LP.oz

OZGSRCS  =

OZFCTS  = $(OZSRCS:.oz=.ozf) $(OZGSRCS:.ozg=.ozf)

TARGETS         = $(OZFCTS) ri.so-$(PLATFORM)
LIB_TARGETS     = $(TARGETS:%=$(LIB_DIR)/%)

.PHONY: all install clean veryclean distclean bootstrap depend

all:            $(TARGETS)
install:        $(LIB_DIR) $(LIB_TARGETS)


#
# Oz part
#

%.ozf: %.oz
        $(OZC) -c $< -o $@

%.ozf: %.ozg
        $(OZC) -c --gump $< -o $@

#
# C part
#

ri.so-$(PLATFORM): $(OBJS)
        $(LD) -o $@ $(OBJS) $(LDFLAGS) $(LIBS)

#
# installation part
#

$(LIB_DIR)/%.ozf: %.ozf
        $(INSTALL_LIB) $< $@

$(LIB_DIR)/%.so-$(PLATFORM): %.so-$(PLATFORM)
        $(INSTALL_LIB) $< $@

#
# maintenance part
#

clean:
        -rm *.ozf
        -rm *.o
        -rm ri.so-$(PLATFORM)
        -rm *.s
        -rm *~

veryclean: clean
        -rm Makefile.deps

%.o: %.cc
        $(CXX) $(OPTIMIZE) $(CFLAGS) -c $< -o $@

%.o: %.c
        $(CXX) $(OPTIMIZE) $(CFLAGS) -c $< -o $@

depend:
        $(DEPEND) $(CSRCS) $(CPPSRCS) > Makefile.deps

-include Makefile.deps

include $(SRCTOP)/share/Makefile.boot

bootstrap: boot-all

#---------------------------------------------------------------------
# Automatic Makefile update
#---------------------------------------------------------------------

Makefile: Makefile.in config.status
        ./config.status

config.status: configure
        ./config.status --recheck
