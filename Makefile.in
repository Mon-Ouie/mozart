#
#  Authors:
#    Michael Mehl (mehl@dfki.de)
# 
#  Contributors:
#    Denys Duchier (duchier@ps.uni-sb.de)
#    Christian Schulte <schulte@ps.uni-sb.de>
# 
#  Copyright:
#    Michael Mehl, 1998
# 
#  Last change:
#    $Date$ by $Author$
#    $Revision$
# 
#  This file is part of Mozart, an implementation 
#  of Oz 3:
#     http://mozart.ps.uni-sb.de
# 
#  See the file "LICENSE" or
#     http://mozart.ps.uni-sb.de/LICENSE.html
#  for information on usage and redistribution 
#  of this file, and for a DISCLAIMER OF ALL 
#  WARRANTIES.

# !!! THIS MAKEFILE REQUIRES GNU MAKE !!!!

######################################################################
# path
######################################################################

BUILDTOP=	@BUILDTOP@
SRCTOP=		@SRCTOP@
SRCDIR=		@srcdir@
VPATH=		@srcdir@
PREFIX=		@prefix@

HOMEURL=	@HOMEURL@
HOMECACHE=      @HOMECACHE@

BINDIR=		$(PREFIX)/bin
SHAREDIR=	$(PREFIX)/share
TOOLSDIR=	$(SHAREDIR)/tools
ELISPDIR=	$(SHAREDIR)/elisp
IMAGESDIR=	$(SHAREDIR)/images
CACHEDIR= 	$(PREFIX)/$(HOMECACHE)
CACHETOOLS= 	$(CACHEDIR)/tools
CACHEBIN=	$(CACHEDIR)/bin
SHARECACHE=	$(CACHEDIR)/share

######################################################################
# programs
######################################################################

MAKE=		@MAKE@
INSTALL=	@INSTALL@
INSTALL_BIN=	$(INSTALL) -m 555
INSTALL_FILE=	$(INSTALL) -m 444
INSTALL_DIR=	@INSTALL_DIR@

######################################################################
# other variables
######################################################################

OZVERSION=	$(SRCTOP)/OZVERSION
FILES=		LICENSE LICENSE.html
ALLFILES=	$(FILES:%=$(PREFIX)/%)

# sub directories for recursive makes
SUBDIRS=	@oz_subdirs@

######################################################################
# common targets
######################################################################

.PHONY: all bootstrap install clean veryclean distclean check

all:: bootstrap

bootstrap clean veryclean depend distclean check install::
	dirs="$(SUBDIRS)"; \
	for i in $$dirs; do \
	  if (cd $$i && $(MAKE) $@); \
          then true; \
          else exit 1; \
          fi; \
        done

clean::
	-rm -f *~

veryclean::
	$(MAKE) clean SUBDIRS=

distclean::
	$(MAKE) veryclean SUBDIRS=
	-rm -f Makefile config.cache config.log config.status

install:: $(PREFIX)

$(PREFIX):
	$(INSTALL_DIR) $@

all:: Makefile

Makefile: Makefile.in ./config.status
	./config.status

./config.status: ./configure
	./config.status --recheck

install:: $(ALLFILES)

$(ALLFILES): $(PREFIX)/% : % $(PREFIX)
	$(INSTALL_FILE) $< $@

######################################################################
# other targets
######################################################################

PLATFORMS=	solaris-sparc aix3-rs600 freebsd-i486 hpux-700\
		irix5-mips linux-i486 netbsd-i486 netbsd-m68k netbsd-sparc\
		osf1-alpha solaris-i486 sunos-sparc win32-i486
PLATFORMFILES=  LICENSE LICENSE.html bin cache contrib include share
COMPRESS=	gzip -9
TAR=		tar
WINCACHEDIR=	oz/cache/$(HOMECACHE)
PACKDIR=	/tmp/pack


.PHONY: src doc $(PLATFORMS)

src: $(PACKDIR)
	(cd $(PACKDIR); \
	 (cd $(SRCTOP)/..; \
	  $(TAR) -cf - mozart) | $(TAR) -xf - ; \
	 find mozart -name CVS -type d -exec rm -rf '{}' ';' 2>/dev/null ; \
	 find mozart -name '.cvsignore' -type f -exec rm -f '{}' ';' ; \
	 $(TAR) -cf - mozart ) | \
	 $(COMPRESS) > mozart-`$(OZVERSION)`.`date +"%m%d%y"`-src.tar.gz
	rm -rf $(PACKDIR)/mozart

doc: $(PACKDIR) $(PACKDIR)/mozart/doc
	(cd $(PACKDIR); \
	(cd $(PREFIX)/doc; \
	 $(TAR) -cf - .) | (cd mozart/doc; $(TAR) -xf -); \
	 $(TAR) -cf - mozart ) | \
	 $(COMPRESS) > mozart-`$(OZVERSION)`.`date +"%m%d%y"`-doc.tar.gz
	rm -rf $(PACKDIR)/mozart

$(PLATFORMS): $(PACKDIR) $(PACKDIR)/mozart
	(cd $(PACKDIR); \
	 (cd $(PREFIX); \
	  $(TAR) -cf - $(PLATFORMFILES) platform/$@ ) | \
	 (cd mozart; $(TAR) -xf - ); \
	 find mozart -name '*.so-*' \
                     -not -name \*.so-$@ -exec rm -f '{}' ';' )
	(cd $(PACKDIR); $(TAR) -cf - mozart/contrib ) | \
	 $(COMPRESS) > mozart-`$(OZVERSION)`.`date +"%m%d%y"`-$@-contrib.tar.gz
	rm -rf $(PACKDIR)/mozart/contrib
	(cd $(PACKDIR); $(TAR) -cf - mozart ) | \
	$(COMPRESS) > mozart-`$(OZVERSION)`.`date +"%m%d%y"`-$@.tar.gz
	rm -rf $(PACKDIR)/mozart


$(PACKDIR) $(PACKDIR)/mozart $(PACKDIR)/mozart/doc:
	$(INSTALL_DIR) $@

oz-win::
	rm -rf oz oz3
	( cd $(PREFIX)/..; \
	  $(TAR) cf - oz/include oz/share \
		   oz/LICENSE \
		   oz/contrib \
		   oz/doc \
		   oz/platform/winbin \
                   oz/platform/win32-i486/?*.exe \
                   oz/platform/win32-i486/?*.dll \
                   oz/platform/win32-i486/wish \
         ) | $(TAR) xf -
	$(INSTALL_DIR) oz/doc
	$(INSTALL_DIR) $(WINCACHEDIR)/share
	$(INSTALL_DIR) $(WINCACHEDIR)/doc/demo
	mv oz/share/images oz/share/?*.ozf $(WINCACHEDIR)/share
	mv oz/doc/demo/applets $(WINCACHEDIR)/doc/demo
	find oz -name '*.so-*' -not -name '*.so-win32-i486' -exec rm -f '{}' ';'
	rm -rf oz/share/doc
	mv $(WINCACHEDIR)/share/Init.ozf oz/share
	for i in ozc ozd ozl; do \
	  cat oz/platform/winbin/ozwrapper.exe \
	      $(PREFIX)/bin/$$i > oz/platform/winbin/$$i.exe;\
        done
	i386-mingw32-strip oz/platform/win32-i486/*.exe
	mv oz/platform/winbin oz/bin
	mv oz oz3
