@SET_MAKE@

BUILDTOP=	@BUILDTOP@
SRCDIR =	@srcdir@
TOPDIR =	@srcdir@

INSTALL=	@INSTALL@
INSTALL_OTHER=	$(INSTALL) -m 444
MKINSTALLDIRS=	@MKINSTALLDIRS@

PREFIX=		@prefix@

OZVERSION=	$(TOPDIR)/OZVERSION

SUBDIRS=	platform share contrib

PLATFORMS=	solaris-sparc aix3-rs600 freebsd-i486 hpux-700\
		irix5-mips linux-i486 netbsd-i486 netbsd-m68k netbsd-sparc\
		osf1-alpha solaris-i486 sunos-sparc win32-i486

DISTDIR=	dist

FILES=		$(wildcard README*) LICENSE
ALLFILES=	$(FILES:%=$(PREFIX)/%)

DIRS=		bin demo include lib platform tools man
LIBDIRS=	elisp browser panel explorer bitmaps compiler wish
ALLDIRS=	$(PREFIX) $(DIRS:%=$(PREFIX)/%) $(LIBDIRS:%=$(PREFIX)/lib/%) \
		$(PLATFORMS:%=$(PREFIX)/platform/%)

COMMONFILES = oz/bin oz/include oz/lib \
		oz/README* oz/LICENSE oz/BUGS \
                oz/man oz/tools \
                oz/cache

DEMOFILES = oz/demo

COMPRESS = compress
ZIP      = gzip -9

CACHEDIR=oz/cache/http/www.ps.uni-sb.de/PREFIX/lib

.PHONY:	bootstrap all install clean distclean realclean veryclean World files check

bootstrap::
all:: bootstrap

clean veryclean realclean distclean::
	-$(RM) *~

distclean::
	-$(RM) Makefile config.cache config.log config.status

check bootstrap all install clean veryclean realclean depend distclean::
	dirs="$(SUBDIRS)"; for i in $$dirs; do (cd $$i && $(MAKE) $@); done

install:: $(ALLFILES)
$(ALLFILES): $(PREFIX)/% : % $(PREFIX)
$(ALLFILES):
	$(INSTALL_OTHER) $(FILES) $(PREFIX)

$(PREFIX) $(DISTDIR):
	$(MKINSTALLDIRS) $@

pack-all: common $(PLATFORMS)

home: mini-common wish-linux src linuxz

src:
	(cd $(SRCDIR)/Emulator; make realclean; cvs update)
	(cd $(SRCDIR); tar vzcf dist/oz-emu.tgz Emulator)
	(cd $(SRCDIR); cvs update -l;
	 tar vzcf dist/oz-misc.tgz \
	  Imake.tmpl Imakefile ozmkmf include bin elisp CVS
	(cd $(SRCDIR)/lib; make realclean; cvs update)
	(cd $(SRCDIR)/TestFiles; cvs update)
	(cd $(SECDIR); tar vzcf dist/oz-lib.tgz lib TestFiles)

mini-common: $(DISTDIR)
	(cd $(PREFIX)/..; \
	tar -zvcf - oz/bin oz/include oz/lib) > \
	   $(DISTDIR)/mini-`$(OZVERSION)`.tgz

common: $(DISTDIR)
	(cd $(PREFIX)/..; \
	tar -cf - $(COMMONFILES)) | \
        $(ZIP) > $(DISTDIR)/oz-`$(OZVERSION)`-$@.tar.gz

demo: $(DISTDIR)
	(cd $(PREFIX)/..; \
	tar -cf - $(DEMOFILES)) | \
        $(ZIP) > $(DISTDIR)/oz-`$(OZVERSION)`-$@.tar.gz

$(PLATFORMS): $(DISTDIR)
	(cd $(PREFIX)/..; \
        tar -cf - oz/platform/$@) | \
        $(ZIP) > $(DISTDIR)/oz-`$(OZVERSION)`-$@.tar.gz

oz-win::
	rm -rf oz oz3 oz-`$(OZVERSION)`
	( cd $(PREFIX)/..; \
	  tar cf - oz/?*.exe oz/demo oz/include oz/lib \
		   oz/LICENSE \
                   oz/platform/win32-i486/?*.exe \
                   oz/platform/win32-i486/?*.dll \
                   oz/platform/win32-i486/tcldoc \
         ) | tar xf -
	rm -f oz/demo/rundemo oz/lib/ozbatch.ozm
	mkdir -p $(CACHEDIR)
	mv oz/lib/?*.ozc $(CACHEDIR)
	mv $(CACHEDIR)/Init.ozc oz/lib
	(cd oz/lib/wish; rm -rf tk tcl; mv tcl8.0 tcl; mv tk8.0 tk)
	mv oz oz3
