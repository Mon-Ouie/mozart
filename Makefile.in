#
#  Authors:
#    Michael Mehl (mehl@dfki.de)
#
#  Contributors:
#    Denys Duchier (duchier@ps.uni-sb.de)
#
#  Copyright:
#
#  Last change:
#    $Date$ by $Author$
#    $Revision$
#
#  This file is part of Mozart, an implementation
#  of Oz 3:
#     $MOZARTURL$
#
#  See the file "LICENSE" or
#     $LICENSEURL$
#  for information on usage and redistribution
#  of this file, and for a DISCLAIMER OF ALL
#  WARRANTIES.

# !!! THIS MAKEFILE REQUIRES GNU MAKE !!!!

######################################################################
# path
######################################################################

BUILDTOP=       @BUILDTOP@
SRCTOP=         @SRCTOP@
SRCDIR=         @srcdir@
VPATH=          @srcdir@
PREFIX=         @prefix@

BINDIR=         $(PREFIX)/bin
LIBDIR=         $(PREFIX)/lib
TOOLSDIR=       $(LIBDIR)/tools
ELISPDIR=       $(LIBDIR)/elisp
IMAGESDIR=      $(LIBDIR)/images
CACHEDIR=       $(PREFIX)/cache/http/www.ps.uni-sb.de/ozhome
CACHETOOLS=     $(CACHEDIR)/tools
CACHEBIN=       $(CACHEDIR)/bin
LIBCACHE=       $(CACHEDIR)/lib
URL=            http\\://www.ps.uni-sb.de/ozhome

######################################################################
# programs
######################################################################

@SET_MAKE@
INSTALL=        @INSTALL@
INSTALL_BIN=    $(INSTALL) -m 555
INSTALL_FILE=   $(INSTALL) -m 444
INSTALL_SRC=    @INSTALL_SRC@
INSTALL_DIR=    @INSTALL_DIR@

TAR=            tar
CVS=            cvs

######################################################################
# other variables
######################################################################

OZVERSION=      $(SRCTOP)/OZVERSION

PLATFORMS=      solaris-sparc aix3-rs600 freebsd-i486 hpux-700\
                irix5-mips linux-i486 netbsd-i486 netbsd-m68k netbsd-sparc\
                osf1-alpha solaris-i486 sunos-sparc win32-i486

DISTDIR=        dist

FILES=          LICENSE
ALLFILES=       $(FILES:%=$(PREFIX)/%)

COMMONFILES=    LICENSE \
                bin include lib tools cache

DEMOFILES=      demo

COMPRESS=       gzip -9

WINCACHEDIR=    oz/cache/http/www.ps.uni-sb.de/PREFIX/lib

# sub directories for recursive makes
SUBDIRS=        platform share contrib

# list of directories to create during install
DIRS=
INSTALLDIRS=    $(PREFIX) $(DIRS:%=$(PREFIX)/%)

######################################################################
# common targets
######################################################################

.PHONY: all bootstrap install clean veryclean distclean check

all:: bootstrap

bootstrap clean veryclean depend distclean check install::
        dirs="$(SUBDIRS)"; \
        for i in $$dirs; do \
          if (cd $$i && $(MAKE) $@); \
          then true; \
          else exit 1; \
          fi; \
        done

clean::
        -rm -f *~

veryclean::
        $(MAKE) clean SUBDIRS=

distclean::
        $(MAKE) veryclean SUBDIRS=
        -rm -f Makefile config.cache config.log config.status

install:: $(INSTALLDIRS)

$(INSTALLDIRS):
        $(INSTALL_DIR) $@

all:: Makefile

Makefile: Makefile.in ./config.status
        ./config.status

./config.status: ./configure
        ./config.status --recheck

######################################################################
# other targets
######################################################################

install:: $(ALLFILES)

# $(ALLFILES): $(PREFIX)/% : % $(PREFIX)

$(ALLFILES): $(FILES)
        $(INSTALL_FILE) $(FILES) $(PREFIX)

$(DISTDIR):
        $(INSTALL_DIR) $@

pack-all: common $(PLATFORMS)

home: mini-common wish-linux src linuxz

src:
        (cd $(SRCDIR)/Emulator; make veryclean; $(CVS) update)
        (cd $(SRCDIR); $(TAR) vzcf dist/oz-emu.tgz Emulator)
        (cd $(SRCDIR); $(CVS) update -l;
         $(TAR) vzcf dist/oz-misc.tgz \
          Imake.tmpl Imakefile ozmkmf include bin elisp CVS
        (cd $(SRCDIR)/lib; make veryclean; $(CVS) update)
        (cd $(SRCDIR)/TestFiles; $(CVS) update)
        (cd $(SECDIR); $(TAR) vzcf dist/oz-lib.tgz lib TestFiles)

mini-common: $(DISTDIR)
        (cd $(PREFIX)/..; \
        $(TAR) -zvcf - oz/bin oz/include oz/lib) > \
           $(DISTDIR)/mini-`$(OZVERSION)`.tgz

common: $(DISTDIR)
        (cd $(PREFIX)/..; \
        $(TAR) -cf - $(COMMONFILES:%=oz/%)) | \
        $(COMPRESS) > $(DISTDIR)/oz-`$(OZVERSION)`-$@.tar.gz

demo: $(DISTDIR)
        (cd $(PREFIX)/..; \
        $(TAR) -cf - $(DEMOFILES:%=oz/%)) | \
        $(COMPRESS) > $(DISTDIR)/oz-`$(OZVERSION)`-$@.tar.gz

$(PLATFORMS): $(DISTDIR)
        (cd $(PREFIX)/..; \
        $(TAR) -cf - oz/platform/$@) | \
        $(COMPRESS) > $(DISTDIR)/oz-`$(OZVERSION)`-$@.tar.gz

oz-win::
        rm -rf oz oz3 oz-`$(OZVERSION)`
        ( cd $(PREFIX)/..; \
          $(TAR) cf - oz/?*.exe oz/demo oz/include oz/lib \
                   oz/LICENSE \
                   oz/platform/win32-i486/?*.exe \
                   oz/platform/win32-i486/?*.dll \
                   oz/platform/win32-i486/tcldoc \
         ) | $(TAR) xf -
        rm -f oz/demo/rundemo oz/lib/ozbatch.ozm
        $(INSTALL_DIR) $(WINCACHEDIR)
        mv oz/lib/?*.ozc $(WINCACHEDIR)
        mv $(WINCACHEDIR)/Init.ozc oz/lib
        (cd oz/lib/wish; rm -rf tk tcl; mv tcl8.0 tcl; mv tk8.0 tk)
        mv oz oz3
