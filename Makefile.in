SRCDIR =        @srcdir@
TOPDIR =        @srcdir@

INSTALL=        @INSTALL@
INSTALL_BIN=    $(INSTALL) -m 555
INSTALL_OTHER=  $(INSTALL) -m 444
INSTALL_DIR=    @MKINSTALLDIRS@

OZHOME=         @prefix@
OZVERSION=      $(TOPDIR)/OZVERSION

SUBDIRS=        bin elisp ozwish Emulator lib

PLATFORMS=      solaris-sparc aix3-rs600 freebsd-i486 hpux-700\
                irix5-mips linux-i486 netbsd-i486 netbsd-m68k netbsd-sparc\
                osf1-alpha solaris-i486 sunos-sparc win32-i486

DISTDIR=        dist

FILES=          README* LICENSE BUGS
ALLFILES=       $(FILES:%=$(OZHOME)/%)

INSTALLDIR=     $(INSTALL) -d -g ps-soft -m 775

DIRS=           bin demo include lib platform tools man
LIBDIRS=        elisp browser panel explorer bitmaps compiler wish
ALLDIRS=        $(OZHOME) $(DIRS:%=$(OZHOME)/%) $(LIBDIRS:%=$(OZHOME)/lib/%) \
                $(PLATFORMS:%=$(OZHOME)/platform/%)

COMMONFILES = oz/bin oz/demo oz/include oz/lib \
                oz/README* oz/LICENSE oz/BUGS \
                oz/man oz/tools \
                oz/cache

COMPRESS = compress
ZIP      = gzip -9

CACHEDIR=oz/cache/http/www.ps.uni-sb.de/ozhome/lib

.PHONY: all install clean distclean realclean veryclean World files

all:

all install clean realclean depend distclean:
        dirs="$(SUBDIRS)"; for i in $$dirs; do (cd $$i && $(MAKE) $@); done

veryclean: realclean

install: $(ALLDIRS) $(ALLFILES)

bootstrap:
        (cd Emulator; make)
        (cd lib; make bootstrap)

$(ALLFILES):
        $(INSTALL) -m 444 $(FILES) $(OZHOME)

$(ALLDIRS) $(DISTDIR):
        $(INSTALLDIR) $@

pack-all: common $(PLATFORMS)

home: mini-common wish-linux src linuxz

src:
        (cd $(SRCDIR)/Emulator; make realclean; cvs update)
        (cd $(SRCDIR); tar vzcf dist/oz-emu.tgz Emulator)
        (cd $(SRCDIR); cvs update -l;
         tar vzcf dist/oz-misc.tgz \
          Imake.tmpl Imakefile ozmkmf include bin elisp CVS
        (cd $(SRCDIR)/lib; make realclean; cvs update)
        (cd $(SRCDIR)/TestFiles; cvs update)
        (cd $(SECDIR); tar vzcf dist/oz-lib.tgz lib TestFiles)

mini-common: $(DISTDIR)
        (cd $(OZHOME)/..; \
        tar -zvcf - oz/bin oz/include oz/lib) > \
           $(DISTDIR)/mini-`$(OZVERSION)`.tgz

common: $(DISTDIR)
        (cd $(OZHOME)/..; \
        tar -cf - $(COMMONFILES)) | \
        $(ZIP) > $(DISTDIR)/oz-`$(OZVERSION)`-$@.tar.gz

$(PLATFORMS): $(DISTDIR)
        (cd $(OZHOME)/..; \
        tar -cf - oz/platform/$@) | \
        $(ZIP) > $(DISTDIR)/oz-`$(OZVERSION)`-$@.tar.gz

oz-win::
        rm -rf oz oz-`$(OZVERSION)`
        ( cd $(OZHOME)/..; \
          tar cf - oz/?*.exe oz/demo oz/include oz/lib \
                   oz/README* oz/LICENSE oz/BUGS oz/ChangeLog \
                   oz/platform/win32-i486/?*.exe \
                   oz/platform/win32-i486/?*.dll \
                   oz/platform/win32-i486/tcldoc \
         ) | tar xf -
        rm -f oz/demo/rundemo oz/lib/compiler/?*.ql
        mkdir -p $(CACHEDIR)
        mv oz/lib/?*.ozc $(CACHEDIR)
        mv $(CACHEDIR)/OPI.ozc oz/lib
        (cd oz/lib/wish; rm -rf tk tcl tcl8.0 tk8.0; mv tcl7.6 tcl; mv tk4.2 tk)
        mv oz oz3
