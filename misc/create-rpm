#!/bin/sh -x
#
#  Authors:
#    Christian Schulte <schulte@ps.uni-sb.de>
# 
#  Copyright:
#    Christian Schulte, 1998
# 
#  Last change:
#    $Date$ by $Author$
#    $Revision$
# 
#  This file is part of Mozart, an implementation 
#  of Oz 3:
#     http://www.mozart-oz.org
# 
#  See the file "LICENSE" or
#     http://www.mozart-oz.org/LICENSE.html
#  for information on usage and redistribution 
#  of this file, and for a DISCLAIMER OF ALL 
#  WARRANTIES.
#

RPMROOT=/usr/src/redhat
RPMSRC=$RPMROOT/SOURCES
RPMSPEC=$RPMROOT/SPECS
TMPDIR=/tmp

#
# Read dir
#
if test $# -lt 2
then
   echo "usage: create-rpm <src-dir> <dst-dir>" 1>&2;
   exit 1;
fi
BUILDDIR=$1
SRCTAR=`ls ${BUILDDIR}/mozart-*.*-src.tar.bz2`
DOCTAR=`ls ${BUILDDIR}/mozart-*.*-doc.tar.bz2`
DSTDIR=$2
OZHOME=/usr/lib/mozart

#
# Find version
#

VERSION=`(echo ${SRCTAR} | sed 's/.*mozart-\(.*\..*\)-src.tar.bz2/\1/')`
BUILD=`(echo $Revision$ | sed 's|.*\.\([1-9][0-9]*\).*|\1|')`

#
# Build sh files
#

cd $TMPDIR

cat > oz.sh <<EOF
export PATH=${OZHOME}/bin:\${PATH}
EOF

cat > oz.csh <<EOF
setenv PATH ${OZHOME}/bin:\${PATH}
EOF

chmod a+x oz.sh oz.csh
tar cf - oz.csh oz.sh | bzip2 -9 > ${RPMSRC}/mozart-profiles.tar.bz2
rm -f oz.sh oz.csh


#
# Build xpm
#

cat > ${RPMSRC}/mozart.xpm <<EOF
/* XPM */
static char * mozart_xpm[] = {
"69 30 32 1",
" 	c None",
".	c #FFFFFF",
"+	c #FFE69E",
"@	c #FBF6E9",
"#	c #F7E7B8",
"\$	c #FAD466",
"%	c #FBCE4A",
"&	c #FFDE7C",
"*	c #FFF3D2",
"=	c #F0D688",
"-	c #E3BA42",
";	c #61501F",
">	c #100F0A",
",	c #000000",
"'	c #392E0F",
")	c #B29030",
"!	c #777777",
"~	c #484848",
"{	c #A7A7A7",
"]	c #282828",
"^	c #D7D7D7",
"/	c #201B08",
"(	c #A18F59",
"_	c #8F8F8F",
":	c #896F25",
"<	c #725C1E",
"[	c #D3AC3E",
"}	c #C0B185",
"|	c #514215",
"1	c #606060",
"2	c #BFBFBF",
"3	c #C2A34C",
"                                #@                                   ",
"                              *\$%&                                   ",
"                            *&&*%%*                                  ",
"                           +\$*  #%\$                                  ",
"                         #\$#    #%%#                                 ",
"                       *\$&      #%%%                                 ",
"                     @=%%\$  #=  +%%%+                                ",
"                    #%%%%%=\$%#  &%%%%*                               ",
"                  #-;>,')%%%%#  \$%%+%&                         !~~   ",
"                *&)>,,,,,;%%%*  %=@ &%*                        ~,,   ",
"              @+%%>,')',,,)%%*  *   #%\$                        ~,,   ",
"~~~{],]_^~,,~@+%%),,)%%/,,/%%     @(>[%#      _],,>~^  !~~!>~_~>,,~~ ",
",,,,,,,,>,,,,~@%%:,,<%%[,,,[%    }',,|%%@    1,,,,,,>^ ~,,,,~!,,,,,, ",
",,,]!>,,,!~,,, #%:,,>%%%',,[%# #;,,,,'%%+   ^,,>{^],,_ ~,,,,~_~,,,~~ ",
",,,2 !,,1 @,,,  \$[,,,;%%:,,[%%3>,,>,,<%%%*  @2!2 ^],,! ~,,>{   ,,,   ",
",,,2 !,,!  ,,,  #%|,,,:[',/%%%%/>)[,,:%%%&   @!],,,,,! ~,,!    ,,,   ",
",,,  !,,!  ,,,   &%/,,,,,,)\$%%%[%%),,)%%%%# @>,,]1],,! ~,,_    ,,,   ",
",,,  !,,!  ,,,   *%%',,,~2   #%%%%:,,[%%:%\$ _,,]@ ~,,! ~,,2    ,,,   ",
",,,  !,,!  ,,,    +%%[[=      *%%%;,,[:>,:%#!,,~ ^>,,! ~,,2    ,,,_2@",
",,,  !,,!  ,,,     %%%%  *&#   #%%',,/,,,:\$*_,,,],,,,! ~,,2    ],,,,2",
",,,  !,,!  ,,,     #%%=  #%%*   %%/,,,,'3#   ~,,,~!,,! ~,,2    {>,,,2",
"                    \$%#  #%%\$   =%/,,/)=@     ^2^                22^ ",
"                    *%&   \$%%#  #%)>:\$*                              ",
"                     &%   *%%+  &%%-#                                ",
"                     *%#   *=*  %%+                                  ",
"                      +%*      =&@                                   ",
"                       %%#   *+*                                     ",
"                       #%%%%%#                                       ",
"                        \$%%+                                         ",
"                        *&*                                          "};
EOF

cp ${SRCTAR} ${DOCTAR} ${RPMSRC}

# Generate redhat spec file
cd $TMPDIR
cat > ${RPMSPEC}/mozart-$VERSION-$BUILD.spec <<EOF
# Spec file for Mozart, an efficient and distributed implementation of Oz
# Author: Christian Schulte, 1998
# Copyright: Christian Schulte, 1998, 1999
Name: mozart
Version: ${VERSION}
Release: ${BUILD}
Summary: Mozart, an efficient and distributed implementation of Oz
Copyright: Free
Vendor: Mozart Consortium
Url: http://www.mozart-oz.org/
Group: Development/Languages
Packager: Christian Schulte <schulte@ps.uni-sb.de>
Icon: mozart.xpm

Source0: ftp://ftp.mozart-oz.org/pub/${VERSION}/tar/mozart-${VERSION}-src.tar.bz2
Source1: ftp://ftp.mozart-oz.org/pub/${VERSION}/tar/mozart-${VERSION}-doc.tar.bz2
Source2: mozart-profiles.tar.bz2

BuildRoot: /var/tmp/mozart-${VERSION}

%description
The Mozart system provides state-of-the-art support in two areas: open
distributed computing and constraint-based inference. Mozart
implements Oz, a concurrent object-oriented language with dataflow
synchronization. Oz combines concurrent and distributed programming
with logical constraint-based inference, making it a unique choice for
developing multi-agent systems. Mozart is an ideal platform for both
general-purpose distributed applications as well as for hard problems
requiring sophisticated optimization and inferencing abilities. We
have developed applications in scheduling and time-tabling, in
placement and configuration, in natural language and knowledge
representation, multi-agent systems and sophisticated collaborative
tools.

Mozart has been jointly developed by the Programming Systems Lab at
DFKI and Universität des Saarlandes, the Swedish Institute of Computer
Science, and Université de Louvain.

This package contains all you need to run and develop Oz programs with
Mozart.
%package doc
Summary: Mozart documentation
Group: Development/Languages
requires: mozart
%description doc
This package contains the extensive Mozart online documentation as a set of
HTML pages. It also contains demo applications that can directly be
started from the pages.
%package contrib
Summary: Mozart contributions
Group: Development/Languages
requires: mozart
%description contrib
This package contains a collection of contributed software packages
for Mozart that might come in handy for applications like a regular
expression package, data base interfaces, and so on.
%prep
rm -rf \$RPM_BUILD_DIR/mozart-${VERSION}
mkdir -p \$RPM_BUILD_DIR/mozart-${VERSION}
cd \$RPM_BUILD_DIR/mozart-${VERSION}
bzip2 -dc \$RPM_SOURCE_DIR/mozart-${VERSION}-src.tar.bz2 | tar xf -
mkdir tmp-doc
cd tmp-doc
bzip2 -dc \$RPM_SOURCE_DIR/mozart-${VERSION}-doc.tar.bz2 | tar xf -
mv mozart/doc ..
cd ..
chown -R root .
chgrp -R root .
chmod -R a+rX,g-w,o-w .
rm -rf tmp-doc 

%build
cd \$RPM_BUILD_DIR/mozart-${VERSION}/mozart
: \${CFLAGS="\$RPM_OPT_FLAGS"}
: \${CXXFLAGS="\$RPM_OPT_FLAGS"}
export CFLAGS CXXFLAGS
./configure --prefix=\$RPM_BUILD_ROOT$OZHOME

make

%install
cd \$RPM_BUILD_DIR/mozart-${VERSION}
PREFIX=\$RPM_BUILD_ROOT$OZHOME
rm -rf \$PREFIX
mkdir -p \$PREFIX
# install docs
rm -rf doc/demo/applets
cp -a doc \$PREFIX
# Generic install
(cd mozart && make install)
# Strip binaries and shared objects
find \$PREFIX -type f -name '*.so*' -exec strip '{}' ';'
find \$PREFIX -type f -name '*.exe' -exec strip '{}' ';'
# config files
mkdir -p \$RPM_BUILD_ROOT/etc/profile.d
cd \$RPM_BUILD_ROOT/etc/profile.d
bzip2 -dc \$RPM_SOURCE_DIR/mozart-profiles.tar.bz2 | tar xf -


%clean
rm -rf \$RPM_BUILD_ROOT
%files
%doc mozart-${VERSION}/mozart/README mozart-${VERSION}/mozart/LICENSE mozart-${VERSION}/mozart/LICENSE.html
%config /etc/profile.d/oz.sh
%config /etc/profile.d/oz.csh
$OZHOME/LICENSE
$OZHOME/LICENSE.html
$OZHOME/bin
$OZHOME/cache
$OZHOME/include
$OZHOME/platform
$OZHOME/share
%files doc
$OZHOME/doc
$OZHOME/examples
%files contrib
$OZHOME/contrib
EOF

#
# No we have all what we need, go and build rpms
#

rpm -ba --clean ${RPMSPEC}/mozart-$VERSION-$BUILD.spec
rm -f ${RPMSPEC}/mozart-$VERSION-$BUILD.spec
rm -f ${RPMSRC}/mozart-$VERSION.tar.*
rm -f ${RPMSRC}/mozart-doc-$VERSION.tar.*
rm -f ${RPMSRC}/mozart-profiles.tar.*

#
# Move the created rpms to destination
#

mv ${RPMROOT}/RPMS/i386/mozart-{,doc-,contrib-}$VERSION-$BUILD.i386.rpm ${DSTDIR}
mv ${RPMROOT}/SRPMS/mozart-$VERSION-$BUILD.src.rpm ${DSTDIR}



