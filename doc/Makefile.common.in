# -*- Makefile -*-

PREFIX          = @prefix@
SRCTOP          = @SRCTOP@
BUILDTOP        = @BUILDTOP@
OZENGINE        = @OZENGINE@
OZDOC           = @OZDOC@
HOMEURL         = @HOMEURL@

OZDOCFLAGS      =
DOCIFY          = $(OZENGINE) $(OZDOC) $(OZDOCFLAGS)

DOCDIR          = $(PREFIX)/doc/$(WHAT)

INSTALL         = @INSTALL@
INSTALL_FILE    = $(INSTALL) -m 444
INSTALL_BIN     = $(INSTALL) -m 555
INSTALL_DIR     = @INSTALL_DIR@

HTMLSUPPORTFILES0 = \
        ozdoc.css page.gif $(HTMLEXTRASUPPORTFILES)
HTMLSUPPORTFILES = \
        $(addprefix $(SRCTOP)/doc/utilities/,$(HTMLSUPPORTFILES0))

.PHONY: all bootstrap bootquick quick validate verify install clean veryclean distclean

all:: Makefile ../Makefile.common $(WHAT)-html/index.html

include $(SRCTOP)/share/Makefile.boot

bootstrap: boot-all

bootquick: boot-quick

Makefile: $(SRCDIR)/Makefile.in ../config.status
        cd .. && ./config.status

../Makefile.common: $(SRCTOP)/doc/Makefile.common.in ../config.status
        cd .. && ./config.status

$(WHAT)-html/index.html: $(MAIN) $(SGMLSRCS) $(HTMLEXTRAFILES)
        rm -f latex.db && \
        $(DOCIFY) $(OZDOCHTMLFLAGS) --in=$< --out=$(WHAT)-html \
        --type=html-stylesheets --stylesheet=ozdoc.css --top=../index.html \
        --bib-path=$(SRCDIR):$(SRCTOP)/doc \
        --bst-path=$(SRCTOP)/doc/utilities \
        --latexdb=latex.db \
        --xrefdb=../xref.db --xrefdir=$(WHAT) && \
        cp -p $(HTMLSUPPORTFILES) $(WHAT)-html && \
        for i in $(addprefix $(SRCTOP)/doc/$(WHAT)/,$(HTMLEXTRAFILES)) NONE; \
        do { test $$i = NONE || cp -p $$i $(WHAT)-html; } done

$(WHAT)-tex/$(WHAT).ps: $(MAIN) $(SGMLSRCS) $(TEXEXTRAFILES)
        $(DOCIFY) $(OZDOCTEXFLAGS) --in=$< --out=$(WHAT)-tex \
        --type=latex \
        --bib-path=$(SRCDIR):$(SRCTOP)/doc \
        --bst-path=$(SRCTOP)/doc/utilities && \
        for i in $(addprefix $(SRCTOP)/doc/$(WHAT)/,$(TEXEXTRAFILES)) NONE; \
        do { test $$i = NONE || cp -p $$i $(WHAT)-tex; } done

quick:: $(MAIN) $(SGMLSRCS) $(HTMLEXTRAFILES)
        $(DOCIFY) $(OZDOCHTMLFLAGS) --in=$< --out=$(WHAT)-html \
        --type=html-stylesheets --stylesheet=ozdoc.css --top=../ \
        --bib-path=$(SRCDIR):$(SRCTOP)/doc \
        --bst-path=$(SRCTOP)/doc/utilities \
        --latexdb=latex.db --keeppictures \
        --xrefdb=../xref.db --xrefdir=$(WHAT) && \
        cp -p $(HTMLSUPPORTFILES) $(WHAT)-html && \
        for i in $(addprefix $(SRCTOP)/doc/$(WHAT)/,$(HTMLEXTRAFILES)) NONE; \
        do { test $$i = NONE || cp -p $$i $(WHAT)-html; } done

verify: $(MAIN)
        nsgmls -s -c$(PREFIX)/share/doc/catalog $<

validate: $(WHAT)-html/index.html
        nsgmls -cHTML4.soc -sB $(WHAT)-html/*.html

install:: $(WHAT)-html/index.html $(DOCDIR)
        for i in $(WHAT)-html/*; do $(INSTALL_FILE) $$i $(DOCDIR); done

$(DOCDIR):
        $(INSTALL_DIR) $@

clean::
        -rm -rf $(WHAT)-html $(WHAT)-tex *~

veryclean: clean
        -rm -f latex.db

distclean: veryclean
        -rm -f Makefile

OZDOC2XML       = $(SRCTOP)/doc/xsl/ozdoc2xml
CLASSPATH       = $(shell echo $$CLASSPATH)
OZCLASSPATH     = $(SRCTOP)/doc/xsl/xt.jar:$(SRCTOP)/doc/xsl/xp.jar:$(SRCTOP)/doc/xsl/sax.jar:../xsl

$(WHAT).xml: $(MAIN) $(SGMLSRCS) $(TEXEXTRAFILES)
        nsgmls -c../catalog $< | $(OZDOC2XML) > $@
$(WHAT).tex: $(WHAT).xml
        java -oss10000000 -classpath $(CLASSPATH):$(OZCLASSPATH)  com.jclark.xsl.sax.Driver $< $(SRCTOP)/doc/xsl/ozdoc.xml $@

TEXINPUTS       = $(shell echo $$TEXINPUTS)
OZTEXINPUTS     = $(SRCDIR):$(TEXINPUTS)
BSTINPUTS       = $(shell echo $$BSTINPUTS)
OZBSTINPUTS     = .:$(SRCDIR):$(BSTINPUTS)
BIBINPUTS       = $(shell echo $$BIBINPUTS)
OZBIBINPUTS     = .:$(SRCDIR):$(BIBINPUTS)

$(WHAT).dvi: $(WHAT).tex pspics
        TEXINPUTS=$(OZTEXINPUTS) latex $< || { rm $@; exit -1; }
        TEXINPUTS=$(OZTEXINPUTS) latex $< || { rm $@; exit -1; }
        -TEXINPUTS=$(OZTEXINPUTS) BSTINPUTS=$(OZBSTINPUTS) BIBINPUTS=$(OZBIBINPUTS) bibtex $*
        TEXINPUTS=$(OZTEXINPUTS) latex $< || { rm $@; exit -1; }
        -TEXINPUTS=$(OZTEXINPUTS) BSTINPUTS=$(OZBSTINPUTS) BIBINPUTS=$(OZBIBINPUTS) bibtex $*
        TEXINPUTS=$(OZTEXINPUTS) latex $< || { rm $@; exit -1; }
$(WHAT).ps: $(WHAT).dvi
        TEXINPUTS=$(OZTEXINPUTS) dvips $< -o $@
ps: $(WHAT).ps
$(WHAT).pics: $(WHAT).xml
        java -oss10000000 -classpath $(CLASSPATH):$(OZCLASSPATH)  com.jclark.xsl.sax.Driver $< $(SRCTOP)/doc/xsl/ozpic.xml $@
pspics: $(WHAT).pics
        for f in `cat $(WHAT).pics`; do $(MAKE) $$f.ps; done
%.gif.ps: %.gif
        giftopnm $< | pnmtops -noturn > $@
%.gif.ps: pictures/%.gif
        giftopnm $< | pnmtops -noturn > $@
