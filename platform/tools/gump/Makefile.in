### NOTES:
###	configure should really look for oz.h and substitute the
###	appropriate dependency

@SET_MAKE@

VPATH		= @srcdir@
BUILDTOP	= @BUILDTOP@
PREFIX		= @prefix@
PLATFORM	= @platform@
SRCDIR		= @srcdir@
SRCTOP		= @SRCTOP@
SUBDIRS		= ozflex ozbison

RM		= @RM@ -f
DYNLD		= @DYNLD@
CXX		= @CXX@
CPPFLAGS	= -I$(SRCDIR) -I. -I$(SRCTOP)/platform/emulator @CPPFLAGS@
CXXFLAGS	= @CXXFLAGS@ $(CFLAGS)
LDFLAGS		= @LDFLAGS@
LIBS		= @LIBS@ -lc
CFLAGS		= -O6

INSTALL		= @INSTALL@
INSTALLPRG	= $(INSTALL) -m 555
INSTALLFILE	= $(INSTALL) -m 444
MKINSTALLDIRS	= @MKINSTALLDIRS@

SHAREDIR = $(PREFIX)/share
SHAREFILES = \
	$(SHAREDIR)/GumpScanner.so-$(PLATFORM) \
	$(SHAREDIR)/ozbison.so-$(PLATFORM)
PLATFORMDIR = $(PREFIX)/platform/$(PLATFORM)
PLATFORMFILES = \
	$(PLATFORMDIR)/oz.flex.bin
INCDIR = $(PREFIX)/include
INCFILES = \
	$(INCDIR)/FlexLexer.h $(INCDIR)/lexer.h

all: Makefile subdirs GumpScanner.so

bootstrap: all

subdirs:
	dirs="$(SUBDIRS)"; \
	for i in $$dirs; do \
	  if (cd $$i && $(MAKE) all); \
          then true; \
          else exit 1; \
          fi; \
        done

GumpScanner.so: GumpScanner.C $(SRCTOP)/platform/emulator/oz.h
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $< -o GumpScanner.o && \
	$(DYNLD) -o $@ GumpScanner.o $(LDFLAGS) $(LIBS)

## here we install shared object libs twice: once in the old
## location and once in the cache.  eventually we should only
## install into the cache, I think.

install: all \
	$(SHAREDIR) $(SHAREFILES) \
	$(PLATFORMDIR) $(PLATFORMFILES) \
	$(INCDIR) $(INCFILES)

$(SHAREDIR) $(PLATFORMDIR) $(INCDIR):
	$(MKINSTALLDIRS) $@

$(SHAREDIR)/GumpScanner.so-$(PLATFORM): GumpScanner.so
	$(INSTALLFILE) $< $@

$(SHAREDIR)/ozbison.so-$(PLATFORM): ozbison/ozbison.so
	$(INSTALLFILE) $< $@

$(PLATFORMDIR)/oz.flex.bin: ozflex/flex
	$(INSTALLPRG) $< $@

$(INCDIR)/%: %
	$(INSTALLFILE) $< $@

clean veryclean:
	$(RM) *~ *.o *.so
	for i in $(SUBDIRS); do (cd $$i && $(MAKE) clean); done

distclean: clean
	$(RM) Makefile config.*
	for i in $(SUBDIRS); do (cd $$i && $(MAKE) distclean); done

Makefile: Makefile.in config.status
	./config.status

config.status: configure
	./config.status --recheck

check:

depend:
