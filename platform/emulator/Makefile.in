#  Authors:
#    Michael Mehl (mehl@dfki.de)
#
#  Contributors:
#    optional, Contributor's name (Contributor's email address)
#
#  Copyright:
#    Michael Mehl, 1998
#
#  Last change:
#    $Date$ by $Author$
#    $Revision$
#
#  This file is part of Mozart, an implementation
#  of Oz 3:
#     $MOZARTURL$
#
#  See the file "LICENSE" or
#     $LICENSEURL$
#  for information on usage and redistribution
#  of this file, and for a DISCLAIMER OF ALL
#  WARRANTIES.

# !!! THIS MAKEFILE REQUIRES GNU MAKE !!!!

############################################################################
# VARIABLES
############################################################################

VPATH=  @srcdir@
SRCDIR= @srcdir@

include Makefile.vars

INCS            = -I. -I$(SRCDIR)
M4_D            = -DEMUDIR=$(SRCDIR)
WIFTARGETS      = @WIFTARGETS@
WIFINSTALL      = @WIFINSTALL@
FDTARGETS       = @FDTARGETS@
FDINSTALL       = @FDINSTALL@
FSETTARGETS     = @FSETTARGETS@
FSETINSTALL     = @FSETINSTALL@
PARSERTARGETS   = @PARSERTARGETS@
PARSERINSTALL   = @PARSERINSTALL@
OZMATARGETS     = @OZMATARGETS@
OZMAINSTALL     = @OZMAINSTALL@
TARGETS         = @TARGETS@
SUBDIRS         = libfd libfset
OZVERSION       = $(SRCTOP)/OZVERSION

CREATEDOTHERS= \
        instrtab.hh opcodes.hh optostr.hh marshaler.hh\
        marshalcode.cc marshalMsg.cc register.hh oz.c \
        config.h builtins.tbl builtins.dcl \
        fdbuilti.tbl fdbuilti.dcl \
        libfd.tbl libfd.dcl \
        libschedule.tbl libschedule.dcl \
        fsetbuilti.tbl fsetbuilti.dcl \
        libfset.tbl libfset.dcl \
        libwif.tbl libwif.dcl \
        libparser.tbl libparser.dcl \
        scanner.cc parser.cc

CREATEDSRCS= \
        copycode.cc opcodes.cc \
        version.cc initffuns.cc

CREATEDFILES= $(CREATEDOTHERS) $(CREATEDSRCS)

PEANUTSFILE= peanuts.cc
PEANUTS= \
        am.cc genvar.cc indexing.cc fdhook.cc \
        taskstk.cc mem.cc assemble.cc \
        fdprofil.cc statisti.cc fdgenvar.cc \
        codearea.cc debug.cc lps.cc solve.cc \
        variable.cc thrqueue.cc thrspool.cc \
        perdiovar.cc lazyvar.cc \
        print.cc

CXXSRCS= \
        actor.cc base.cc board.cc thread.cc \
        dictionary.cc stack.cc susplist.cc \
        cpbag.cc tagged.cc value.cc \
        cont.cc ozconfig.cc trail.cc \
        foreign.cc \
        ofgenvar.cc genhashtbl.cc \
        ozostream.cc runtime.cc unix.cc \
        metavar.cc perdio.cc \
        urlc.cc iso-ctype.cc hashtbl.cc \
        os.cc emulate.cc scheduler.cc builtins.cc \
        components.cc network.cc virtual.cc \
        comm.cc marshaler.cc liveness.cc gc.cc \
        vprops.cc promise.cc \
        vs_comm.cc vs_mailbox.cc vs_msgbuffer.cc \
        ctgenvar.cc \
        simplevar.cc

FDSRCS=\
        fdbuilti.cc fdomn.cc fdcore.cc \
        fdcd.cc fdbvar.cc

CPISRCS=\
        cpi.cc cpi_fd.cc cpi_prop.cc \
        cpi_fs.cc cpi_expect.cc cpi_misc.cc \
        cpi_stream.cc cpi_profile.cc cpi_ct.cc

FSETSRCS=\
        fset.cc fsetcore.cc fsgenvar.cc

SRCS1=  $(FDSRCS) $(FSETSRCS) $(CPISRCS) $(CXXSRCS) @PEANUTS@ main.cc

SRCS=   $(CREATEDSRCS) $(SRCS1)

OBJS = $(SRCS:.cc=.o)

############################################################################
### TARGETS
############################################################################

.NOEXPORT: emulate.o @PROGRAMNAME@ peanuts.o
.PHONY: all win win-install first install install-bin install-inc \
        install-dir version depend tags clean distclean veryclean \
        libfd.a libschedule.a libfset.a libfd.so libschedule.so libfset.so \
        install-wif install-fd install-fset install-parser

all: $(TARGETS)

bootstrap:: all

$(FDTARGETS) $(FDINSTALL): libfd.dcl libfd.tbl libschedule.tbl libschedule.dcl
        cd libfd; $(MAKE) $@

$(FSETTARGETS) $(FSETINSTALL): libfset.dcl libfset.tbl
        cd libfset; $(MAKE) $@


libwif.so: wif.o
        $(DYNLD) -o $@ wif.o

libwif.a: wif.o
        $(AR) -rc $@ wif.o && $(RANLIB) $@

win: ozlib.lnk $(CREATEDFILES)


PRGDEP=$(CREATEDFILES) $(SRCS) $(OBJS) $(OZMALIB)

first: $(CREATEDFILES) $(SRCS)

@PROGRAMNAME@: $(PRGDEP)
        $(MAKE) $(FDTARGETS) $(FSETTARGETS) $(WIFTARGETS) \
        $(PARSERTARGETS) $(OZMATARGETS)
        $(LD) $(LDFLAGS) $(LDOPT) -o $@ $(OBJS) $(LIBS)

@oz_tmphack_programname@: $(PRGDEP)
        $(MAKE) $(FDTARGETS) $(FSETTARGETS) $(WIFTARGETS) \
        $(PARSERTARGETS) $(OZMATARGETS)
        tmp=/tmp/ozemu$$$$; \
        trap "rm -f $$tmp; exit 1" 1 2 15; \
         $(LD) $(LDFLAGS) $(LDOPT) -o $$tmp $(OBJS) $(LIBS) && \
         echo 'moving ...' && \
         rcp $$tmp @oz_tmphack_host@:`pwd`/$@ && \
         rm -f $$tmp

install:: install-bin install-inc \
        $(WIFINSTALL) $(FDINSTALL) $(FSETINSTALL) \
        $(PARSERINSTALL) $(OZMAINSTALL)

install-bin: version $(TARGETS) $(BINDIR)
        $(INSTALL_BIN) $(TARGETS) $(BINDIR)

install-inc: $(INCDIR)
        $(INSTALL_FILE) $(SRCDIR)/oz.h $(INCDIR)
        $(INSTALL_FILE) $(SRCDIR)/oz_cpi.hh $(INCDIR)

install-wif: libwif.so $(BINDIR)
        $(INSTALL_BIN) libwif.so $(BINDIR)

install-parser: libparser.so $(BINDIR)
        $(INSTALL_BIN) libparser.so $(BINDIR)

install-ozma: libozma.so $(BINDIR)
        $(INSTALL_BIN) libozma.so $(BINDIR)

$(BINDIR) $(INCDIR):
        $(INSTALL_DIR) $@

initffuns.cc oz.c: oz.h $(OZVERSION)
        $(SHELL) $(SRCDIR)/makeffuns $(SRCDIR) `$(OZVERSION)`

version.cc: version.sed
        $(MAKE) version

version:
        sed -e "s/HEREGOESDATE/`date '+%h %d 19%y \(%T\)'`/" \
             -e "s/OZPLATFORM/$(PLATFORM)/" \
             $(SRCDIR)/version.sed > version.cc

depend:: Makefile $(CREATEDFILES) $(SRCS)
        $(DEPEND) $(SRCDIR)/wif.cc $(SRCS1:%=$(SRCDIR)/%) $(CREATEDSRCS) > Makefile.deps

## prefered gmake depend!
## include $(SRCS:.cc=.d)

tags:   $(CREATEDFILES) version.cc
        etags \
        --regex='/OZ_BI_\(io\)?define([         ]*\([^  ,)]+\)/\2/' \
        --regex='/OZ_C_\(io\)?proc_begin([      ]*\([^  ,)]+\)/\2/' -l c++ \
        -o $(SRCDIR)/TAGS \
        $(CREATEDFILES) \
        $(SRCDIR)/*c $(SRCDIR)/*h $(SRCDIR)/*/*c $(SRCDIR)/*/*h

clean::
        -rm -f gmon.out  fetchedInstr.dump verb_out.txt

ozlib.lnk: oz.h
        grep FUNDECL oz.h | grep -v typedef | grep -v define | \
        sed -e 's/.*_FUNDECL(\([A-Za-z0-9_]*\).*/export _\1/' > $@

scanner.cc: scanner.ll
        $(LEX) $(LFLAGS) -Pxy -o$@ $<

parser.cc: parser.hh
        @echo > /dev/null

parser.hh: parser.yy
        $(YACC) $(YFLAGS) -p xy $<
        @mv y.tab.c parser.cc
        @mv y.tab.h parser.hh

libparser.so: parser.o scanner.o parsertable.o
        $(DYNLD) -o $@ parser.o scanner.o parsertable.o

libparser.a: parser.o scanner.o parsertable.o
        $(AR) -rc $@ parser.o scanner.o parsertable.o && $(RANLIB) $@

builtins.o: builtins.tbl builtins.dcl

fdbuilti.o: fdbuilti.tbl fdbuilti.dcl

fsetcore.o: fsetbuilti.tbl fsetbuilti.dcl

wif.o: libwif.tbl libwif.dcl

parsertable.o: libparser.dcl libparser.tbl

builtins.o: \
        libwif.tbl libwif.dcl \
        libfd.tbl libfd.dcl libschedule.tbl libschedule.dcl \
        libfset.tbl libfset.dcl \
        libparser.tbl libparser.dcl


builtins.tbl: bidecl.perl
        perl $(SRCDIR)/bidecl.perl -ctable \
        -exclude wif,fd,libfd,libschedule,fset,libfset,libparser > $@
builtins.dcl: bidecl.perl
        perl $(SRCDIR)/bidecl.perl -cdecl \
        -exclude wif,fd,libfd,libschedule,fset,libfset,libparser > $@

fdbuilti.tbl: bidecl.perl
        perl $(SRCDIR)/bidecl.perl -ctable -include fd > $@
fdbuilti.dcl: bidecl.perl
        perl $(SRCDIR)/bidecl.perl -cdecl -include fd > $@

fsetbuilti.tbl: bidecl.perl
        perl $(SRCDIR)/bidecl.perl -ctable -include fset > $@
fsetbuilti.dcl: bidecl.perl
        perl $(SRCDIR)/bidecl.perl -cdecl -include fset > $@

libwif.tbl: bidecl.perl
        perl $(SRCDIR)/bidecl.perl -cdyntable -include wif > $@
libwif.dcl: bidecl.perl
        perl $(SRCDIR)/bidecl.perl -cdecl -include wif > $@

libfd.tbl: bidecl.perl
        perl $(SRCDIR)/bidecl.perl -cdyntable -include libfd > $@
libfd.dcl: bidecl.perl
        perl $(SRCDIR)/bidecl.perl -cdecl -include libfd > $@

libschedule.tbl: bidecl.perl
        perl $(SRCDIR)/bidecl.perl -cdyntable -include libschedule > $@
libschedule.dcl: bidecl.perl
        perl $(SRCDIR)/bidecl.perl -cdecl -include libschedule > $@

libfset.tbl: bidecl.perl
        perl $(SRCDIR)/bidecl.perl -cdyntable -include libfset > $@
libfset.dcl: bidecl.perl
        perl $(SRCDIR)/bidecl.perl -cdecl -include libfset > $@

libparser.tbl: bidecl.perl
        perl $(SRCDIR)/bidecl.perl -cdyntable -include libparser > $@
libparser.dcl: bidecl.perl
        perl $(SRCDIR)/bidecl.perl -cdecl -include libparser > $@



# this special rule ensures that warnings issued in bison.simple
# are not treated as errors:
parser.o: parser.cc
        $(CXX) $(CPPFLAGS) $(CXXFLAGS_NO_ERROR) -c $< -o $@

config.h: config.m4h $(OZVERSION)
        $(M4) $(M4_D) -DOZVERSION=\"`$(OZVERSION)`\" $(SRCDIR)/config.m4h > $@

#/usr/include/signal.h is broken on Linux:
#os.cc: In function `void osBlockSignals(int = 0)':
#os.cc:208: warning: assignment of negative value `-1' to `long unsigned int'
os.o: os.cc
        $(CXX) $(CPPFLAGS) $(CXXFLAGS_NO_ERROR) -c $< -o $@

# dependencies
-include Makefile.deps

marshaler.hh marshalMsg.cc: msgFormat.m4
copycode.cc optostr.hh marshalcode.cc opcodes.hh opcodes.cc instrtab.hh config.h: instrDefs.m4

marshaler.o: marshalcode.cc

# automatic configure
${srcdir}/configure: configure.in
        @echo configure.in was changes: cd ${srcdir} && autoconf -l ..

conf.h: conf.h.in
        @echo conf.h.in was changed: ./config.status

Makefile: Makefile.in
        @echo Makefile.in was changed: ./config.status

Makefile.vars: Makefile.vars.in
        @echo Makefile.vars.in was changed: ./config.status

Makefile.rules: Makefile.rules.in
        @echo Makefule.rules.in was changed: ./config.status

config.status: configure
        @echo configure was changed: ./config.status --recheck


# ozma
ozma-s.cc: ozma-s.ll
        $(LEX) $(LFLAGS) -Pozma $<
        @mv lex.ozma.c ozma-s.cc

ozma-p.cc ozma.hh: ozma-p.yy
        $(YACC) $(YFLAGS) -p ozma $<
        @mv y.tab.c ozma-p.cc
        @mv y.tab.h ozma.hh

ozma-s.ll ozma-p.yy: instrDefs.m4
ozma-p.o ozma-s.o: config.h opcodes.hh

# this special rule ensures that warnings issued in bison.simple
# are not treated as errors:
ozma-p.o: ozma-p.cc
        $(CXX) $(CPPFLAGS) $(CXXFLAGS_NO_ERROR) -c $< -o $@

ozma-s.ll: ozma-s.m4ll
        $(M4) $(M4_D) $< > $@

ozma-p.yy: ozma-p.m4yy
        $(M4) $(M4_D) $< > $@

libozma.so: ozma-p.o ozma-s.o
        $(DYNLD) -o $@ ozma-p.o ozma-s.o -lc

libozma.a: ozma-p.o ozma-s.o
        $(AR) -rc $@ ozma-p.o ozma-s.o && $(RANLIB) $@

veryclean::
        -rm -f ozma-p.cc ozma-p.yy ozma-s.cc ozma-s.ll ozma.hh

############################################################################
# testing the local emulator:
#   make test-check       # runs the test suite with local emulator
#   make test-stage1-check # ... with the stage1 components
#   make lib-check        # runs the check in the lib with local emulator
############################################################################

.PHONY: test-all test lib-all check

test-all:
        OZEMULATOR=`pwd`/oz.emulator.bin; export OZEMULATOR; \
        cd $(TESTDIR) && ./configure && make clean all
        $(MAKE) test1;

test:
        OZEMULATOR=`pwd`/oz.emulator.bin; export OZEMULATOR; \
        cd $(TESTDIR) && \
        $(MAKE) check

lib-all:
        $(MAKE) lib-check

lib-%:
        OZEMULATOR=`pwd`/oz.emulator.bin && export OZEMULATOR; \
        cd $(LIBDIR) && \
        $(MAKE) $*

test-%:
        OZEMULATOR=`pwd`/oz.emulator.bin && export OZEMULATOR; \
        cd $(TESTDIR) && \
        $(MAKE) $*

check-all: oz.emulator.bin
        $(MAKE) test
        $(MAKE) lib-check


############################################################################
# RULES
############################################################################

include Makefile.rules

# should be after make in subdirs (see Makefiles.rules)

veryclean::
        -rm -f version.cc scanner.cc parser.cc parser.hh $(TARGETS) \
                ozlib.lnk *.exe *.map *.imp *.sym \
                $(CREATEDFILES) TAGS

distclean::
        -rm -f CONF.h conf.h config.cache config.log config.status \
                Makefile.rules Makefile.vars Makefile
