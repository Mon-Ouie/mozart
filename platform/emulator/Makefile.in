#  Authors:
#    Michael Mehl (mehl@dfki.de)
#
#  Contributors:
#    optional, Contributor's name (Contributor's email address)
#
#  Copyright:
#    Michael Mehl, 1998
#
#  Last change:
#    $Date$ by $Author$
#    $Revision$
#
#  This file is part of Mozart, an implementation
#  of Oz 3:
#     http://mozart.ps.uni-sb.de
#
#  See the file "LICENSE" or
#     http://mozart.ps.uni-sb.de/LICENSE.html
#  for information on usage and redistribution
#  of this file, and for a DISCLAIMER OF ALL
#  WARRANTIES.

# !!! THIS MAKEFILE REQUIRES GNU MAKE !!!!

############################################################################
# VARIABLES
############################################################################

VPATH=  @srcdir@
SRCDIR= @srcdir@

include Makefile.vars

DYN_MODULE_NAMES =\
        Wif Schedule FDP FSP Parser \
        CompilerSupport Browser Debug

STATIC_MODULELIBS=      -L. ${DYN_MODULE_NAMES:%=-l%}
STATIC_MODULETARGETS=   $(DYN_MODULE_NAMES:%=lib%.a)
DYNAMIC_MODULETARGETS=  $(DYN_MODULE_NAMES:%=%.so)

CORE_MODULE_NAMES=      Run OF FS FD CPI OS Space Store Mem Support
# mm2: spliting emulator into different libraries does not work,
#      because some files are not linked into emulator.exe, which
#      are only required from dynamic modules
# CORE_LIBS=    -L. ${CORE_MODULE_NAMES:%=-l%}
CORE_TARGETS=   ${CORE_MODULE_NAMES:%=lib%.a}

# kost@, Per: let's link against libdp statically (so far);
# mm2: removed from DYN_MODULE_NAMES to fix parallel make problem
CORE_LIBS=      -L. libDP.a
LIBS=           $(CORE_LIBS) @LIBS@

INCS=           -I. -I$(SRCDIR)
M4_D=           -DEMUDIR=$(SRCDIR)
TARGETS=        @TARGETS@ text2pickle oztool.sh
MODULETARGETS=  @MODULETARGETS@
# kost@, Per: temporary: include libDP.a:
MODULETARGETS += libDP.a
MODULEINSTALL=  @MODULEINSTALL@
SUBDIRS=        libdp libfd libfset
OZVERSION=      $(SRCTOP)/OZVERSION

# these are the builtin modules: non-sited primitives
# NOTE: update this list also in share/lib/Makefile.in
BIMODSPECS = \
        Array Atom BitArray Bool Cell Char Chunk Class \
        Dictionary Exception Float ForeignPointer Int List Literal \
        Lock Name Number Object Port Procedure Record Space \
        String Thread Time Tuple Unit Value VirtualString \
        BitString ByteString

MODSPECS= \
        FDP FSP Schedule Wif Parser OS Property Pickle \
        PID URL FDB FSB System Finalize CTB \
        CompilerSupport Profile \
        Debug Fault Browser Misc DPMisc Distribution \
        VirtualSite Native \
        $(BIMODSPECS)

MODINTERS = $(MODSPECS:%=mod%-if.cc)

CREATEDSRCS=scanner.cc parser.cc

CREATEDFILES=                                           \
        instrtab.hh opcodes.hh                          \
        marshalcode.cc register.hh mozart.c             \
        atoms.hh atoms.cc                               \
        config.h scanner.cc parser.cc                   \
        version.cc initffuns.cc copycode.cc opcodes.cc  \
        $(MODINTERS)

OTHERSRCS= \
        main.cc \
        version.cc initffuns.cc \
        statisti.cc trace.cc \
        print.cc base.cc ozconfig.cc \
        foreign.cc boot-manager.cc \
        builtins.cc vprops.cc debug.cc

SUPPORTSRCS=\
        stack.cc genhashtbl.cc ozostream.cc hashtbl.cc \
        iso-ctype.cc

OSSRCS=\
        os.cc unix.cc urlc.cc ioHandler.cc

STORESRCS=\
        tagged.cc value.cc atoms.cc \
        dictionary.cc extension.cc bitarray.cc \
        ozthread.cc heapchunk.cc susplist.cc \
        var_base.cc var_simple.cc var_future.cc \
        bytedata.cc

RUNSRCS=\
        am.cc indexing.cc codearea.cc lps.cc \
        trail.cc emulate.cc scheduler.cc \
        copycode.cc opcodes.cc controlvar.cc \
        cont.cc prop_int.cc suspension.cc prop_class.cc \
        thr_stack.cc thr_class.cc thr_pool.cc \
        thr_queue.cc thr_int.cc

SPACESRCS=\
        actor.cc board.cc solve.cc cpbag.cc space.cc

MEMSRCS=\
        gc.cc mem.cc liveness.cc

COMPONENTSSRCS=\
        gname.cc components.cc marshaler.cc site.cc

OFSRCS= var_of.cc ofbi.cc

FDSRCS=\
        fdomn.cc fdcore.cc \
        fdcd.cc var_fd.cc var_bool.cc

CPISRCS=\
        cpi.cc cpi_fd.cc cpi_prop.cc \
        cpi_fs.cc cpi_expect.cc cpi_misc.cc \
        cpi_stream.cc cpi_profile.cc cpi_ct.cc \
        var_ct.cc

FSETSRCS=\
        fset.cc fsetcore.cc var_fs.cc

TEXT2PICKLESRCS= text2pickle.cc opcodes.cc
TEXT2PICKLEOBJS= $(TEXT2PICKLESRCS:.cc=.o)

SRCS= \
        $(SUPPORTSRCS) $(MEMSRCS) $(STORESRCS) \
        $(SPACESRCS) $(RUNSRCS) $(OSSRCS) \
        $(CPISRCS) $(FDSRCS) $(FSETSRCS) $(OFSRCS) \
        $(COMPONENTSSRCS)

# mm2: if enabled CORE_LIBS uncomment the following
COREOBJS=   $(SRCS:%.cc=%.o)

OBJS=   $(COREOBJS) $(OTHERSRCS:%.cc=%.o)

WIFSRCS=        wif.cc
COMPILERSUPPORTSRCS=    compiler.cc
BROWSERSRCS=    browser.cc
DEBUGSRCS=      debugBI.cc

WIFOBJS=        $(WIFSRCS:%.cc=%.o)
COMPILERSUPPORTOBJS=    $(COMPILERSUPPORTSRCS:%.cc=%.o)
BROWSEROBJS=    $(BROWSERSRCS:%.cc=%.o)
DEBUGOBJS=      $(DEBUGSRCS:%.cc=%.o)

ALLSRCS= $(SRCS) \
        $(WIFSRCS) $(COMPILERSUPPORTSRCS) $(BROWSERSRCS) \
        $(DEBUGSRCS) $(TEXT2PICKLESRCS)

############################################################################
### TARGETS
############################################################################

.NOEXPORT: emulate.o @PROGRAMNAME@
.PHONY: all win win-install first install install-bin install-inc \
        install-dir depend tags clean distclean veryclean \
        install-module

all: $(TARGETS)

bootstrap:: all

$(MODINTERS): bidecl.perl

.PHONY: libDP.a DP.so
libDP.a DP.so:
        cd libdp; $(MAKE) ../$@

.PHONY: libFDP.a FDP.so libSchedule.a Schedule.so
libFDP.a FDP.so libSchedule.a Schedule.so:
        cd libfd; $(MAKE) ../$@

.PHONY: libFSP.a FSP.so
libFSP.a FSP.so:
        cd libfset; $(MAKE) ../$@

Wif.so: $(WIFOBJS)
        $(DYNLD) -o $@ $(WIFOBJS)

libWif.a: $(WIFOBJS)
        $(AR) -rc $@ $(WIFOBJS) && $(RANLIB) $@

CompilerSupport.so: $(COMPILERSUPPORTOBJS)
        $(DYNLD) -o $@ $(COMPILERSUPPORTOBJS)

libCompilerSupport.a: $(COMPILERSUPPORTOBJS)
        $(AR) -rc $@ $(COMPILERSUPPORTOBJS) && $(RANLIB) $@

browser.o: modBrowser-if.cc

Browser.so: $(BROWSEROBJS)
        $(DYNLD) -o $@ $(BROWSEROBJS)

libBrowser.a: $(BROWSEROBJS)
        $(AR) -rc $@ $(BROWSEROBJS) && $(RANLIB) $@

Debug.so: $(DEBUGOBJS)
        $(DYNLD) -o $@ $(DEBUGOBJS)

libDebug.a: $(DEBUGOBJS)
        $(AR) -rc $@ $(DEBUGOBJS) && $(RANLIB) $@

libOF.a: $(OFSRCS:%.cc=%.o)
        $(AR) -rc $@ $(OFSRCS:%.cc=%.o) && $(RANLIB) $@

libFD.a: $(FDSRCS:%.cc=%.o)
        $(AR) -rc $@ $(FDSRCS:%.cc=%.o) && $(RANLIB) $@

libFS.a: $(FSETSRCS:%.cc=%.o)
        $(AR) -rc $@ $(FSETSRCS:%.cc=%.o) && $(RANLIB) $@

libCPI.a: $(CPISRCS:%.cc=%.o)
        $(AR) -rc $@ $(CPISRCS:%.cc=%.o) && $(RANLIB) $@

libStore.a: $(STORESRCS:%.cc=%.o)
        $(AR) -rc $@ $(STORESRCS:%.cc=%.o) && $(RANLIB) $@

libSupport.a: $(SUPPORTSRCS:%.cc=%.o)
        $(AR) -rc $@ $(SUPPORTSRCS:%.cc=%.o) && $(RANLIB) $@

libSpace.a: $(SPACESRCS:%.cc=%.o)
        $(AR) -rc $@ $(SPACESRCS:%.cc=%.o) && $(RANLIB) $@

libRun.a: $(RUNSRCS:%.cc=%.o)
        $(AR) -rc $@ $(RUNSRCS:%.cc=%.o) && $(RANLIB) $@

libOS.a: $(OSSRCS:%.cc=%.o)
        $(AR) -rc $@ $(OSSRCS:%.cc=%.o) && $(RANLIB) $@

libMem.a: $(MEMSRCS:%.cc=%.o)
        $(AR) -rc $@ $(MEMSRCS:%.cc=%.o) && $(RANLIB) $@

win: ozlib.lnk $(CREATEDFILES)

PRGDEP=$(CREATEDFILES) $(OBJS) $(MODULETARGETS)

# mm2
# PRGDEP+=$(CORE_TARGETS)

libs: $(CORE_TARGETS)

first: $(CREATEDFILES)

@PROGRAMNAME@: $(PRGDEP)
        $(LD) $(LDFLAGS) $(LDOPT) -o $@ $(OBJS) $(LIBS)

@oz_tmphack_programname@: $(PRGDEP)
        tmp=/tmp/ozemu$$$$; \
        trap "rm -f $$tmp; exit 1" 1 2 15; \
         $(LD) $(LDFLAGS) $(LDOPT) -o $$tmp $(OBJS) $(LIBS) && \
         echo 'moving ...' && \
         rcp $$tmp @oz_tmphack_host@:`pwd`/$@ && \
         rm -f $$tmp

text2pickle: $(TEXT2PICKLEOBJS)
        $(LD) $(LDFLAGS) $(LDOPT) -o $@ $(TEXT2PICKLEOBJS)

install:: install-bin install-inc $(MODULEINSTALL)

install-bin: $(TARGETS) $(BINDIR)
        $(INSTALL_BIN) $(TARGETS) $(BINDIR)

install-inc: $(INCDIR)
        $(INSTALL_FILE) $(SRCDIR)/mozart.h $(INCDIR)
        $(INSTALL_FILE) $(SRCDIR)/extension.hh $(INCDIR)
        $(INSTALL_FILE) $(BUILDDIR)/mozart.c $(INCDIR)
        $(INSTALL_FILE) $(SRCDIR)/oz_cpi.hh $(INCDIR)

install-module: $(DYNAMIC_MODULETARGETS) $(BINDIR)
        $(INSTALL_BIN) $(DYNAMIC_MODULETARGETS) $(BINDIR)

$(BINDIR) $(INCDIR):
        $(INSTALL_DIR) $@

initffuns.cc mozart.c: mozart.h $(OZVERSION)
        $(SHELL) $(SRCDIR)/makeffuns $(SRCDIR) `$(OZVERSION)`

version.cc: version.sed $(filter-out version.cc,$(ALLSRCS))
        sed -e "s/HEREGOESDATE/`date '+%h %d %Y \(%T\)'`/" \
             -e "s/OZPLATFORM/$(PLATFORM)/" \
             $(SRCDIR)/version.sed > version.cc

depend:: version.cc initffuns.cc $(CREATEDSRCS) $(ALLSRCS)
        $(MAKE) first
        $(DEPEND) $^ > Makefile.deps

BUILDDIR=$(shell pwd)
tags:   $(CREATEDFILES) version.cc
        etags \
        --regex='/OZ_BI_\(io\)?define([         ]*\([^  ,)]+\)/\2/' \
        --regex='/OZ_C_\(io\)?proc_begin([      ]*\([^  ,)]+\)/\2/' -l c++ \
        -o $(SRCDIR)/TAGS \
        $(addprefix $(BUILDDIR)/,$(CREATEDFILES)) \
        $(SRCDIR)/*c $(SRCDIR)/*h $(SRCDIR)/*/*c $(SRCDIR)/*/*h

clean::
        -rm -f gmon.out  fetchedInstr.dump verb_out.txt

ozlib.lnk: mozart.h
        grep FUNDECL mozart.h | grep -v typedef | grep -v define | \
        sed -e 's/.*_FUNDECL(\([A-Za-z0-9_]*\).*/export _\1/' > $@

scanner.cc: scanner.ll
        $(LEX) $(LFLAGS) -Pxy -o$@ $<

parser.cc: parser.hh
        @echo > /dev/null

parser.hh: parser.yy
        $(YACC) $(YFLAGS) -p xy $<
        @mv y.tab.c parser.cc
        @mv y.tab.h parser.hh

Parser.so: parser.o scanner.o parsertable.o
        $(DYNLD) -o $@ parser.o scanner.o parsertable.o

libParser.a: parser.o scanner.o parsertable.o
        $(AR) -rc $@ parser.o scanner.o parsertable.o && $(RANLIB) $@

wif.o: modWif-if.cc

parsertable.o: modParser-if.cc

compiler.o: modCompilerSupport-if.cc

boot-manager.o: $(MODINTERS)

%-if.cc: %.spec
        $(PERL) $(SRCDIR)/bidecl.perl -file $< -interface > $@

# this special rule ensures that warnings issued in bison.simple
# are not treated as errors:
parser.o: parser.cc
        $(CXX) $(CPPFLAGS) $(CXXFLAGS_NO_ERROR) -c $< -o $@

config.h: config.m4h $(OZVERSION)
        $(M4) $(M4_D) -DOZVERSION=\"`$(OZVERSION)`\" $(SRCDIR)/config.m4h > $@

# dependencies
-include Makefile.deps

value.o: atoms.hh

copycode.cc marshalcode.cc opcodes.hh opcodes.cc instrtab.hh config.h: instrDefs.m4

marshaler.o: marshalcode.cc pickle.cc
text2Pickle.o: pickle.cc
components.o: componentBuffer.cc

# automatic configure
#${srcdir}/configure: configure.in
#       cd ${srcdir} && autoconf -l ..

conf.h: conf.h.in
        ./config.status

Makefile: Makefile.in
        ./config.status

Makefile.vars: Makefile.vars.in
        ./config.status

Makefile.rules: Makefile.rules.in
        ./config.status

config.status: configure
        ./config.status --recheck

############################################################################
# testing the local emulator:
#   make test-check       # runs the test suite with local emulator
#   make test-stage1-check # ... with the stage1 components
#   make lib-check        # runs the check in the lib with local emulator
############################################################################

.PHONY: test-all test lib-all check

test:
        OZEMULATOR=`pwd`/emulator.exe; export OZEMULATOR; \
        cd $(TESTDIR) && \
        $(MAKE) check

lib-all:
        $(MAKE) lib-check

lib-%:
        OZEMULATOR=`pwd`/emulator.exe && export OZEMULATOR; \
        cd $(LIBDIR) && \
        $(MAKE) $*

test-%:
        OZEMULATOR=`pwd`/emulator.exe && export OZEMULATOR; \
        cd $(TESTDIR) && \
        $(MAKE) $*

check-all: emulator.exe
        $(MAKE) test
        $(MAKE) lib-check


############################################################################
# RULES
############################################################################

include Makefile.rules

atoms.cc: atoms.perl
        $(PERL) $< -body > $@

atoms.hh: atoms.perl
        $(PERL) $< -header > $@

# should be after make in subdirs (see Makefiles.rules)

veryclean::
        -rm -f version.cc scanner.cc parser.cc parser.hh $(TARGETS) \
                ozlib.lnk *.exe *.map *.imp *.sym \
                $(CREATEDFILES) TAGS Makefile.deps

distclean::
        -rm -f OZCONF.h conf.h config.cache config.log config.status \
                Makefile.rules Makefile.vars Makefile
