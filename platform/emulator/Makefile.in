#  Authors:
#    Michael Mehl (mehl@dfki.de)
# 
#  Contributors:
#    optional, Contributor's name (Contributor's email address)
# 
#  Copyright:
#    Michael Mehl (mehl@dfki.de)
# 
#  Last change:
#    $Date$ by $Author$
#    $Revision$
# 
#  This file is part of Mozart, an implementation 
#  of Oz 3:
#     $MOZARTURL$
# 
#  See the file "LICENSE" or
#     $LICENSEURL$
#  for information on usage and redistribution 
#  of this file, and for a DISCLAIMER OF ALL 
#  WARRANTIES.

# !!! THIS MAKEFILE REQUIRES GNU MAKE !!!!

VPATH		= @srcdir@
SRCDIR		= @srcdir@
TOPDIR		= @TOPDIR@

include Makefile.vars

INCS		= -I. -I$(SRCDIR)
M4_D		= -DEMUDIR=$(SRCDIR)
FDTARGETS	= @FDTARGETS@
FSETTARGETS	= @FSETTARGETS@
TARGETS		= @TARGETS@
SUBDIRS		= FDLib FSetLib
OZVERSION	= $(TOPDIR)/OZVERSION

CREATEDOTHERS = \
	instrtab.hh opcodes.hh optostr.hh marshaler.hh\
	marshalcode.cc marshalMsg.cc register.hh oz.c \
	config.h builtins.tbl builtins.dcl \
	fdbuilti.tbl fdbuilti.dcl

CREATEDSRCS = \
	scancode.cc copycode.cc opcodes.cc\
	scanner.cc parser.cc version.cc initffuns.cc

CREATEDFILES = $(CREATEDOTHERS) $(CREATEDSRCS)

PEANUTSFILE = peanuts.cc
PEANUTS = \
	am.cc genvar.cc	indexing.cc fdhook.cc\
	taskstk.cc mem.cc assemble.cc\
	fdprofil.cc statisti.cc fdgenvar.cc\
	codearea.cc debug.cc lps.cc solve.cc\
	variable.cc thrqueue.cc thrspool.cc\
	avar.cc perdiovar.cc lazyvar.cc\
	print.cc

CXXSRCS = \
	actor.cc base.cc board.cc thread.cc\
	dictionary.cc stack.cc susplist.cc\
	cpbag.cc tagged.cc value.cc\
	cont.cc ozconfig.cc trail.cc\
	foreign.cc \
	compiler.cc ofgenvar.cc genhashtbl.cc\
	ozostream.cc runtime.cc unix.cc\
	tcl_tk.cc metavar.cc perdio.cc\
	urlc.cc iso-ctype.cc hashtbl.cc\
	os.cc emulate.cc scheduler.cc builtins.cc\
	components.cc network.cc virtual.cc\
	comm.cc marshaler.cc liveness.cc gc.cc\
	vprops.cc 

FDSRCS =\
	fdbuilti.cc fdomn.cc fdcore.cc\
	fdcd.cc fdbvar.cc fddist.cc 

CPISRCS =\
	cpi.cc cpi_fd.cc cpi_prop.cc\
	cpi_fs.cc cpi_expect.cc cpi_misc.cc\
	cpi_stream.cc cpi_profile.cc

FSETSRCS =\
	fset.cc fsetcore.cc fsgenvar.cc

SRCS1 = $(FDSRCS) $(FSETSRCS) $(CPISRCS) $(CXXSRCS) @PEANUTS@ main.cc

SRCS = $(CREATEDSRCS) $(SRCS1) 

OBJS = $(SRCS:.cc=.o)

.NOEXPORT: emulate.o @PROGRAMNAME@ peanuts.o
.PHONY:	all subdirs win win-install first install install-bin install-inc \
	install-dir version depend tags clean distclean realclean veryclean \
	$(FDTARGETS) $(FSETTARGETS)

all: $(TARGETS)

$(FDTARGETS):
	cd FDLib; $(MAKE) $@

$(FSETTARGETS):
	cd FSetLib; $(MAKE) $@

win: ozlib.lnk $(CREATEDFILES)

first: $(CREATEDFILES) $(SRCS)

@PROGRAMNAME@: first $(OBJS) $(FDTARGETS) $(FSETTARGETS)
	$(LD) $(LDFLAGS) $(LDOPT) -o $@ $(OBJS) $(LIBS)

@oz_tmphack_programname@: first $(OBJS) $(FDTARGETS) $(FSETTARGETS)
	tmp=/tmp/ozemu$$$$; \
	trap "$(RM) $$tmp; exit 1" 1 2 15; \
	 $(LD) $(LDFLAGS) $(LDOPT) -o $$tmp $(OBJS) $(LIBS) && \
	 echo 'moving ...' && \
	 rcp $$tmp @oz_tmphack_host@:`pwd`/$@ && \
	 $(RM) $$tmp

install:: install-bin install-inc

install-bin: version $(TARGETS) $(BINDIR)
	$(INSTALL_BIN) $(TARGETS) $(BINDIR)

install-inc: $(INCDIR)
	$(INSTALL_OTHER) $(SRCDIR)/oz.h $(INCDIR)
	$(INSTALL_OTHER) $(SRCDIR)/oz_cpi.hh $(INCDIR)

$(BINDIR) $(INCDIR):
	$(INSTALL_DIR) $@

initffuns.cc oz.c: oz.h $(OZVERSION)
	$(SRCDIR)/makeffuns $(SRCDIR) `$(OZVERSION)`

version.cc: version.sed
	$(MAKE) version

version:
	$(SED) -e "s/HEREGOESDATE/`date '+%h %d 19%y \(%T\)'`/" \
	     -e "s/OZPLATFORM/$(PLATFORM)/" \
	     $(SRCDIR)/version.sed > version.cc

depend:: Makefile $(CREATEDFILES) $(SRCS)
	$(DEPEND) $(SRCS1:%=$(SRCDIR)/%) $(CREATEDSRCS) >> Makefile

# prefered gmake depend!
# include $(SRCS:.cc=.d)

tags::	$(CREATEDFILES) version.cc

clean::
	$(RM) gmon.out  fetchedInstr.dump verb_out.txt

ozlib.lnk: oz.h
	grep FUNDECL oz.h | grep -v typedef | grep -v define | \
	sed -e 's/.*_FUNDECL(\([A-Za-z0-9_]*\).*/export _\1/' > $@

scanner.cc: scanner.ll
	$(LEX) $(LFLAGS) -Pxy -o$@ $<

parser.cc: parser.hh
	@echo > /dev/null

parser.hh: parser.yy
	$(YACC) $(YFLAGS) -p xy $<
	@$(MV) y.tab.c parser.cc
	@$(MV) y.tab.h parser.hh

builtins.o: builtins.tbl builtins.dcl
fdbuilti.o: fdbuilti.tbl fdbuilti.dcl
builtins.tbl: bidecl.perl
	perl $(SRCDIR)/bidecl.perl -ctable -exclude fd > $@
builtins.dcl: bidecl.perl
	perl $(SRCDIR)/bidecl.perl -cdecl -exclude fd > $@
fdbuilti.tbl: bidecl.perl
	perl $(SRCDIR)/bidecl.perl -ctable -include fd > $@
fdbuilti.dcl: bidecl.perl
	perl $(SRCDIR)/bidecl.perl -cdecl -include fd > $@

# this special rule ensures that warnings issued in bison.simple
# are not treated as errors:
parser.o: parser.cc
	$(CXX) $(CPPFLAGS) $(CXXFLAGS_NO_ERROR) -c $< -o $@

config.h: config.m4h $(OZVERSION)
	$(M4) $(M4_D) -DOZVERSION=\"`$(OZVERSION)`\" $(SRCDIR)/config.m4h > $@

#/usr/include/signal.h is broken on Linux:
#os.cc: In function `void osBlockSignals(int = 0)':
#os.cc:208: warning: assignment of negative value `-1' to `long unsigned int'
os.o: os.cc
	$(CXX) $(CPPFLAGS) $(CXXFLAGS_NO_ERROR) -c $< -o $@

include Makefile.rules

# realclean should be after make in subdirs (see Makefiles.rules)

realclean::
	$(RM) version.cc scanner.cc parser.cc parser.hh $(TARGETS) \
		ozlib.lnk *.exe *.map *.imp *.sym \
		$(CREATEDFILES) TAGS

distclean::
	$(RM) conf.h config.cache config.log config.status \
		Makefile.rules Makefile.vars Makefile

# dependencies
marshaler.hh marshalMsg.cc: msgFormat.m4
scancode.cc copycode.cc optostr.hh marshalcode.cc opcodes.hh opcodes.cc instrtab.hh: instrDefs.m4

# automatic configure
${srcdir}/configure: configure.in
	$(ECHO) configure.in was changes: cd ${srcdir} && autoconf -l ..

conf.h: conf.h.in
	$(ECHO) conf.h.in was changed: ./config.status

Makefile: Makefile.in
	$(ECHO) Makefile.in was changed: ./config.status

Makefile.vars: Makefile.vars.in
	$(ECHO) Makefile.vars.in was changed: ./config.status

Makefile.rules: Makefile.rules.in
	$(ECHO) Makefule.rules.in was changed: ./config.status

config.status: configure
	$(ECHO) configure was changed: ./config.status --recheck


# ozma
ozma-s.cc: ozma-s.ll
	$(LEX) $(LFLAGS) -Pozma $<
	@$(MV) lex.ozma.c ozma-s.cc

ozma-p.cc ozma.hh: ozma-p.yy
	$(YACC) $(YFLAGS) -p ozma $<
	@$(MV) y.tab.c ozma-p.cc
	@$(MV) y.tab.h ozma.hh

ozma-s.ll ozma-p.yy: instrDefs.m4
ozma-p.o ozma-s.o: config.h opcodes.hh

# this special rule ensures that warnings issued in bison.simple
# are not treated as errors:
ozma-p.o: ozma-p.cc
	$(CXX) $(CPPFLAGS) $(CXXFLAGS_NO_ERROR) -c $< -o $@

ozma-s.ll: ozma-s.m4ll
	$(M4) $(M4_D) $< > $@

ozma-p.yy: ozma-p.m4yy
	$(M4) $(M4_D) $< > $@

ozma.so: ozma-p.o ozma-s.o
	$(DYNLD) -o $@ ozma-p.o ozma-s.o -lc

realclean::
	$(RM) ozma-p.cc ozma-p.yy ozma-s.cc ozma-s.ll ozma.hh

test:
	(OZEMULATOR=`pwd`/oz.emulator.bin; export OZEMULATOR; \
	 cd $(SRCDIR)/../test; make clean all; ./oztest --verbose)

test-lib:
	(OZEMULATOR=`pwd`/oz.emulator.bin; export OZEMULATOR; \
	 cd $(SRCDIR)/../lib; make clean all)
