#  Authors:
#    Michael Mehl (mehl@dfki.de)
#
#  Contributors:
#    optional, Contributor's name (Contributor's email address)
#
#  Copyright:
#    Michael Mehl (mehl@dfki.de)
#
#  Last change:
#    $Date$ by $Author$
#    $Revision$
#
#  This file is part of Mozart, an implementation
#  of Oz 3:
#     $MOZARTURL$
#
#  See the file "LICENSE" or
#     $LICENSEURL$
#  for information on usage and redistribution
#  of this file, and for a DISCLAIMER OF ALL
#  WARRANTIES.

export

# Programs
SUBDIRS         = FDLib FSetLib
srcdir          = @srcdir@
VPATH           = @srcdir@
SHELL           = @SH@
LEX             = @LEX@
LFLAGS          = -8
YACC            = @YACC@
YFLAGS          = -d
MV              = @MV@
SED             = @SED@
ECHO            = @@ECHO@
OZINCDIR        = $(srcdir)/../include
M4A             = -DOZINCDIR=$(OZINCDIR) -DOZSRCDIR=$(srcdir)
M4              = @M4@ $(M4A)
M4_S            = @M4_S@ $(M4A)
RM              = @RM@ -f
CXX             = @CXX@
LD              = @LD@
DYNLD           = @DYNLD@
RANLIB          = @RANLIB@
AR              = @AR@

INSTALL         = @INSTALL@
INSTALL_DIR     = $(INSTALL) -m 775 -d
INSTALL_BIN     = $(INSTALL) -m 555
INSTALL_OTHER   = $(INSTALL) -m 444
LIBS            = @LIBS@
LDFLAGS         = @LDFLAGS@

COPT            = @COPT@
DEFS            = @DEFS@
CWARN           = @CWARN@
INCS            = -I. -I$(srcdir) -I$(OZINCDIR)
CFLAGS          = $(COPT) $(DEFS) $(INCS) $(CWARN) $(CUSR)
CXXFLAGS        = $(CFLAGS)
DEPEND          = @DEPEND@ $(DEFS) $(INCS)

PROGRAMNAME     = @PROGRAMNAME@
TARGETS         = @TARGETS@

prefix          = @prefix@
platform        = @platform@
platformdir     = $(prefix)/platform
bindir          = $(platformdir)/$(platform)
incdir          = $(prefix)/include

INSTRDEFS = $(OZINCDIR)/instrDefs.m4

MOREWARNINGS  =   -Wall -pedantic-errors -W -Wtraditional -Wshadow \
        -Wpointer-arith -Wbad-function-cast -Wcast-qual -Wcast-align \
        -Wwrite-strings -Wconversion -Waggregate-return -Wstrict-prototypes \
        -Wmissing-prototypes -Wmissing-declarations -Wredundant-decls \
        -Wnested-externs -Winline -Woverloaded-virtual -Wsynth -Werror

CWARN = -Wall -W -Wpointer-arith -Wbad-function-cast -Wcast-qual \
        -Wstrict-prototypes -Wmissing-prototypes -Wmissing-declarations \
        -Wnested-externs -Wsynth -Wno-unused -Wno-reorder -Wno-uninitialized

ERRWARN = -Werr

WARNLINUXDEBUG = -W -Wswitch -Wreturn-type -Wparentheses -Wimplicit \
        /*-Wpointer-arithm*/ -Wconversion /*-Wshadow*/ -Wcast-align

M4FILES = \
        scancode.cc instrtab.hh opcodes.hh optostr.hh \
        register.hh opcodes.cc marshalcode.cc marshaler.hh \
        marshalMsg.cc ozma-p.yy ozma-s.ll

PEANUTS = \
        am.cc genvar.cc \
        indexing.cc fdhook.cc taskstk.cc mem.cc \
        assemble.cc error.cc fdprofil.cc \
        statisti.cc fdgenvar.cc \
        codearea.cc debug.cc lps.cc \
        solve.cc variable.cc thrqueue.cc thrspool.cc \
        avar.cc perdiovar.cc \
        lazyvar.cc print.cc

CXXSRCS = actor.cc board.cc thread.cc dictionary.cc stack.cc \
        susplist.cc cpbag.cc \
        tagged.cc value.cc cont.cc config.cc trail.cc types.cc \
        foreign.cc gc.cc compiler.cc ofgenvar.cc opcodes.cc \
        scancode.cc genhashtbl.cc ozostream.cc\
        scanner.cc parser.cc runtime.cc unix.cc tcl_tk.cc \
        version.cc metavar.cc perdio.cc initffuns.cc \
        urlc.cc iso-ctype.cc hashtbl.cc os.cc \
        emulate.cc builtins.cc \
        components.cc network.cc virtual.cc\
        comm.cc marshaler.cc ozma-s.cc ozma-p.cc \
        liveness.cc

FDSRCS =        fdbuilti.cc fdomn.cc fdcore.cc fdcd.cc \
                fdbvar.cc fddist.cc

CPISRCS =       cpi.cc cpi_fd.cc cpi_prop.cc cpi_fs.cc \
                cpi_expect.cc cpi_misc.cc cpi_stream.cc \
                cpi_profile.cc

FSETSRCS =      fset.cc fsetcore.cc fsgenvar.cc

SRCS = $(FDSRCS) $(FSETSRCS) $(CPISRCS) $(CXXSRCS) @PEANUTS@

OBJS = $(SRCS:.cc=.o)

.NOEXPORT: emulate.o $(PROGRAMNAME) peanuts.o

all: subdirs $(TARGETS)

subdirs:
        for d in $(SUBDIRS); do (cd $$d; $(MAKE) all); done

win: ozlib.lnk $(M4FILES)

win-install:
        $(INSTALL_BIN) ozemulator.exe $(bindir)

first: version $(M4FILES) $(SRCS)

$(PROGRAMNAME): first main.o $(OBJS) $(PROPOBJS)
        $(LD) $(LDFLAGS) $(LDOPT) -o $@ \
           main.o $(OBJS) $(PROPOBJS) $(LIBS)

install: install-dir install-bin install-inc
        for d in $(SUBDIRS); do (cd $$d; $(MAKE) install); done

install-bin: $(TARGETS)
        $(INSTALL_BIN) $(TARGETS) $(bindir)

install-inc:
        $(INSTALL_OTHER) oz.h $(incdir)
        $(INSTALL_OTHER) oz_cpi.hh $(incdir)

install-dir:
        if test ! -d $(platformdir) ; then $(INSTALL_DIR) $(platformdir) ; fi
        if test ! -d $(bindir); then $(INSTALL_DIR) $(bindir) ; fi
        if test ! -d $(incdir); then $(INSTALL_DIR) $(incdir) ; fi

version.cc: version

emulate.cc:: register.hh

initffuns.cc oz.c: oz.h
        $(srcdir)/makeffuns $(srcdir)

version:
        $(SED) -e "s/HEREGOESDATE/`date '+%a %h, %d, 19%y \(%T\)'`/" \
             -e "s/OZPLATFORM/$(platform)/" \
             $(srcdir)/version.sed > version.cc


depend: $(M4FILES) $(SRCS)
        $(DEPEND) $(SRCS) >> Makefile
        for d in $(SUBDIRS); do (cd $$d; $(MAKE) depend); done

$(M4FILES): $(INSTRDEFS)

tags:   $(M4FILES) version.cc
        etags --regex='/OZ_C[^(]+([     ]*\([^  ,)]+\)/\1/' -l c++ \
        *c *h */*c */*h

clean+: clean
        $(RM) $(TARGETS)

clean:
        $(RM) *.o *~  *.bak *.obj gmon.out  fetchedInstr.dump verb_out.txt
        for d in $(SUBDIRS); do (cd $$d; $(MAKE) clean); done

realclean: clean
        $(RM) version.cc scanner.cc parser.cc parser.hh $(TARGETS) \
                ozma-s.cc ozma-p.cc ozma.hh \
                ozlib.lnk *.exe *.map *.imp *.sym *.so \
                $(M4FILES) \
                oz.c initffuns.cc TAGS \
                conf.h Makefile config.cache config.log config.status
        for d in $(SUBDIRS); do (cd $$d; $(MAKE) realclean); done

veryclean: realclean

ozlib.lnk: oz.h
        grep FUNDECL oz.h | grep -v typedef | grep -v define | \
        sed -e 's/.*_FUNDECL(\([A-Za-z0-9_]*\).*/export _\1/' > $@

scanner.cc: scanner.ll
        $(LEX) $(LFLAGS) -Pxy -t $< > scanner.cc

parser.cc parser.hh: parser.yy
        $(YACC) $(YFLAGS) -p xy $<
        @$(MV) y.tab.c parser.cc
        @$(MV) y.tab.h parser.hh

# this special rule ensures that warnings issued in bison.simple
# are not treated as errors:
parser.o: parser.cc
        $(CXX) $(CXXFLAGS) -w -c $< -o $@

ozma-s.cc: ozma-s.ll
        $(LEX) $(LFLAGS) -Pozma -t $< > ozma-s.cc

ozma-p.cc ozma.hh: ozma-p.yy
        $(YACC) $(YFLAGS) -p ozma $<
        @$(MV) y.tab.c ozma-p.cc
        @$(MV) y.tab.h ozma.hh

ozma-p.o: ozma-p.cc
        $(CXX) $(CXXFLAGS) -w -c $< -o $@

ozma-s.ll: ozma-s.m4ll
        $(M4) $< > $@

ozma-p.yy: ozma-p.m4yy
        $(M4) $< > $@

#/usr/include/signal.h is broken on Linux:
#os.cc: In function `void osBlockSignals(int = 0)':
#os.cc:208: warning: assignment of negative value `-1' to `long unsigned int'
#os.o: os.cc
#       $(CXX) $(CXXFLAGS) -w -c $< -o $@

.SUFFIXES: .cc .m4cc .hh .m4hh .s .E .sed

.cc.s:
        $(CXX) $(CXXFLAGS) -S -o $@ $<

.cc.E:
        $(CXX) $(CXXFLAGS) -E -o $@ $<

.m4cc.cc:
        $(M4_S) $< > $@

.m4hh.hh:
        $(M4_S) $< > $@
