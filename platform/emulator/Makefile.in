# DFKI Oz (C) DFKI 1991-1997

# Programs
srcdir          = @srcdir@
VPATH           = @srcdir@
SHELL           = @SH@
LEX             = @LEX@
LFLAGS          = -Pxy -8
YACC            = @YACC@
YFLAGS          = -d -p xy
MV              = @MV@
SED             = @SED@
ECHO            = @@ECHO@
M4              = @M4@
RM              = @RM@ -f
CXX             = @CXX@

LIBS            = @LIBS@
LDFLAGS         = @LDFLAGS@

COPT            = @COPT@
DEFS            = @DEFS@
CFLAGS          = $(COPT) $(DEFS) $(CDYN) $(CUSR)
CXXFLAGS        = $(CFLAGS) $(CCINCLUDES)
CXXDEPEND       = $(CXX) $(CXXFLAGS) -MM

MOREWARNINGS  =   -Wall -pedantic-errors -W -Wtraditional -Wshadow \
        -Wpointer-arith -Wbad-function-cast -Wcast-qual -Wcast-align \
        -Wwrite-strings -Wconversion -Waggregate-return -Wstrict-prototypes \
        -Wmissing-prototypes -Wmissing-declarations -Wredundant-decls \
        -Wnested-externs -Winline -Woverloaded-virtual -Wsynth -Werror

CWARN = -Wall -W -Wpointer-arith -Wbad-function-cast -Wcast-qual \
        -Wstrict-prototypes -Wmissing-prototypes -Wmissing-declarations \
        -Wnested-externs -Wsynth -Wno-unused -Wno-reorder -Wno-uninitialized

ERRWARN = -Werr

INSTRDEFS = ../include/instrDefs.m4

M4FILES = scancode.cc instrtab.hh opcodes.hh optostr.hh \
          register.hh opcodes.cc marshallcode.cc

PEANUTS = am.cc genvar.cc \
        indexing.cc fdhook.cc taskstk.cc mem.cc \
        assemble.cc error.cc fdprofil.cc \
        statisti.cc fdgenvar.cc \
        codearea.cc debug.cc lps.cc \
        solve.cc variable.cc thrqueue.cc thrspool.cc \
        avar.cc perdiovar.cc \
        lazyvar.cc print.cc

CXXSRCS = actor.cc board.cc thread.cc dictionary.cc stack.cc \
        susplist.cc cpbag.cc \
        tagged.cc value.cc cont.cc config.cc trail.cc types.cc \
        foreign.cc gc.cc compiler.cc ofgenvar.cc opcodes.cc \
        scancode.cc genhashtbl.cc ozostream.cc\
        scanner.cc parser.cc runtime.cc unix.cc tcl_tk.cc \
        version.cc metavar.cc ip.cc perdio.cc initffuns.cc \
        urlc.cc iso-ctype.cc hashtbl.cc os.cc \
        emulate.cc builtins.cc

FDSRCS =        fdbuilti.cc fdomn.cc fdcore.cc fdcd.cc \
                fdbvar.cc fddist.cc

CPISRCS =       cpi.cc cpi_fd.cc cpi_prop.cc cpi_fs.cc \
                cpi_expect.cc cpi_misc.cc cpi_stream.cc \
                cpi_profile.cc

FSETSRCS =      fset.cc fsetcore.cc fsgenvar.cc


SRCS = $(FDSRCS) $(FSETSRCS) $(CPISRCS) $(CXXSRCS) @PEANUTS@

OBJS = $(SRCS:.cc=.o)

FDDIR = $(srcdir)/FDLib

FDLIBSRCS = $(FDDIR)/arith.cc $(FDDIR)/fdaux.cc $(FDDIR)/bool.cc \
            $(FDDIR)/card.cc $(FDDIR)/cd.cc $(FDDIR)/count.cc \
            $(FDDIR)/rel.cc $(FDDIR)/disjoint.cc $(FDDIR)/std.cc \
            $(FDDIR)/sum.cc $(FDDIR)/sumequal.cc \
            $(FDDIR)/distance.cc $(FDDIR)/misc.cc $(FDDIR)/streamProps.cc \
            $(FDDIR)/sumd.cc $(FDDIR)/sumabs.cc

FDLIBOBJS = $(FDLIBSRCS:.cc=.o)

SCHEDLIBSRCS = $(FDDIR)/scheduling.cc $(FDDIR)/schedulingDist.cc \
               $(FDDIR)/schedulingDistAux.cc $(FDDIR)/taskintervals.cc

SCHEDLIBOBJS = $(SCHEDLIBSRCS:.cc=.o)

FSETDIR = $(srcdir)/FSetLib

FSETLIBSRCS =   $(FSETDIR)/standard.cc $(FSETDIR)/telling.cc \
                $(FSETDIR)/testing.cc $(FSETDIR)/fsaux.cc \
                $(FSETDIR)/intsets.cc $(FSETDIR)/monitor.cc \
                $(FSETDIR)/reified.cc $(FSETDIR)/fsstd.cc \
                $(FSETDIR)/std_n.cc

FSETLIBOBJS = $(FSETLIBSRCS:.cc=.o)

PROPOBJ = $(FDLIBOBJS) $(SCHEDLIBOBJS) $(FSETLIBOBJS)

DESTBIN = $(OZHOME)/platform/@platform@

EMUEXE = oz.emulator.bin

.NOEXPORT: emulate.o @EMUEXE@ peanuts.o

all:: @EMUEXE@

win:: ozlib.lnk $(M4FILES)

win-install::
        Install(ozemulator.exe,775,$(OZHOME)/platform/win32-i486)

first: version $(M4FILES) $(SRCS)


fd: $(FDLIB) $(SCHEDLIB)

@EMUEXE@: first main.o $(OBJS) @PROPOBJ@ $(FDLIB) $(SCHEDLIB)
        $(CXX) $(LDFLAGS) $(LDOPT) -o /tmp/$@.$$$$ \
           main.o $(OBJS) @PROPOBJ@ $(LIBS); \
        echo 'moving ...'; mv /tmp/$@.$$$$ $@

install:: $(DESTBIN)/oz.emulator.bin \
        $(OZHOME)/include/oz.h \
        $(OZHOME)/include/oz_cpi.hh

$(DESTBIN)/oz.emulator.bin: oz.emulator.bin
        Install(oz.emulator.bin,755,$(DESTBIN))

$(OZHOME)/include/oz.h: oz.h
        Install($<,755,$(OZHOME)/include)

$(OZHOME)/include/oz_cpi.hh: oz_cpi.hh
        Install($<,755,$(OZHOME)/include)


version.cc: version

emulate.cc:: register.hh

initffuns.cc oz.c: oz.h
        ./makeffuns

version::
        $(SED) -e "s/HEREGOESDATE/`date '+%a %h, %d, 19%y \(%T\)'`/" \
             -e "s/OZPLATFORM/@platform@/" \
             $(srcdir)/version.sed > version.cc


depend:: $(M4FILES) $(SRCS)
        ozmkmf $(ARGS)
        $(CXXDEPEND) $(CCINCLUDES) $(SRCS) >> Makefile


$(M4FILES): $(INSTRDEFS)

tags:   $(M4FILES) version.cc
        etags -C $(SRCS) *.hh

clean::
        $(RM) *.o *~  *.bak *.obj gmon.out  fetchedInstr.dump verb_out.txt

realclean::
        $(RM) version.cc @EMUEXE@
        $(RM) ozlib.lnk *.exe *.map *.imp *.sym
        $(RM) $(M4FILES)

ozlib.lnk: oz.h
        grep FUNDECL oz.h | grep -v typedef | grep -v define | \
        sed -e 's/.*_FUNDECL(\([A-Za-z0-9_]*\).*/export _\1/' > $@

scanner.cc: scanner.ll
        $(LEX) $(LFLAGS) -t scanner.ll > scanner.cc

parser.cc parser.hh: parser.yy
        $(YACC) $(YFLAGS) parser.yy
        @mv y.tab.c parser.cc
        @mv y.tab.h parser.hh


.SUFFIXES: .cc .m4cc .hh .m4hh .s .E .sed

.cc.s:
        $(CXX) $(CXXFLAGS) -S -o $@ $<

.cc.E:
        $(CXX) $(CXXFLAGS) -E -o $@ $<

.m4cc.cc:
        $(M4) $< > $@

.m4hh.hh:
        $(M4) $< > $@
