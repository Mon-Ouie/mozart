.PHONY: tags clean+ clean realclean veryclean

install clean realclean depend distclean::
        dirs="$(SUBDIRS)"; for i in $$dirs; do (cd $$i && $(MAKE) $@); done

realclean::
        $(MAKE) clean SUBDIRS=

distclean::
        $(MAKE) realclean SUBDIRS=

clean::
        $(RM) *.o *~  *.bak *.obj *.so *.a

veryclean: realclean

tags::
        etags \
        --regex='/OZ_BI_\(io\)?define([         ]*\([^  ,)]+\)/\2/' \
        --regex='/OZ_C_\(io\)?proc_begin([      ]*\([^  ,)]+\)/\2/' -l c++ \
        -o $(SRCDIR)/TAGS \
        $(CREATEDFILES) \
        $(SRCDIR)/*c $(SRCDIR)/*h $(SRCDIR)/*/*c $(SRCDIR)/*/*h

.SUFFIXES: .cc .m4cc .hh .m4hh .s .i .sed

.cc.s:
        $(CXX) $(CPPFLAGS) $(CXXFLAGS) -S -o $@ $<

.cc.i:
        $(CXXCPP) $(CPPFLAGS) -o $@ $<

.m4cc.cc:
        $(M4) $(M4_S) $(M4_D) $< > $@ || ($(RM) $@; exit 1)

.m4hh.hh:
        $(M4) $(M4_S) $(M4_D) $< > $@ || ($(RM) $@; exit 1)

@oz_tmphack_target@:
        tmp=/tmp/ozobj$$$$.o; \
        trap "$(RM) $$tmp; exit 1" 1 2 15; \
        $(CXX) $(CPPFLAGS) $(CXXFLAGS) -c -o $$tmp $< && \
                rcp $$tmp @oz_tmphack_host@:`pwd`/$@ && \
                rm -f $$tmp

%.d: %.cc
        $(DEPEND) $< | sed "s/$*.o/& $@/g" > $@
