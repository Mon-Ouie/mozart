#  Authors:
#    Konstantin Popov <kost@sics.se>
#
#  Contributors:
#    optional, Contributor's name (Contributor's email address)
#
#  Copyright:
#    Michael Mehl (mehl@dfki.de)
#
#  Last change:
#    $Date$ by $Author$
#    $Revision$
#
#  This file is part of Mozart, an implementation
#  of Oz 3:
#     http://mozart.ps.uni-sb.de
#
#  See the file "LICENSE" or
#     http://mozart.ps.uni-sb.de/LICENSE.html
#  for information on usage and redistribution
#  of this file, and for a DISCLAIMER OF ALL
#  WARRANTIES.

include ../Makefile.vars

BUILDTOP        = @BUILDTOP@
VPATH           = @srcdir@
SRCDIR          = @srcdir@
INCS            = -I. -I$(SRCDIR)/.. -I..
M4_D=           -DEMUDIR=$(SRCDIR)
LIBS=           @LIBS@

REALCORESRCS = dpMarshaler.cc port.cc dpDebug.cc network.cc             \
               protocolState.cc dsite.cc perdio.cc state.cc             \
               vs_interface.cc fail.cc protocolCredit.cc table.cc       \
               protocolFail.cc var.cc var_obj.cc msgType.cc chain.cc    \
               dpResource.cc
CREATEDCOREFILES = marshalMsg.cc dpMarshaler.hh
CREATEDCORESRCS  = marshalMsg.cc
CORESRCS = $(REALCORESRCS) $(CREATEDCORESRCS)
COREOBJS = $(CORESRCS:.cc=.o)

REALVSSRCS = virtual.cc vs_comm.cc vs_mailbox.cc vs_msgbuffer.cc
VSSRCS = $(REALVSSRCS)
VSOBJS = $(VSSRCS:.cc=.o)

MODULESRCS = pidModule.cc faultModule.cc dpMiscModule.cc
MODULEOBJS = $(MODULESRCS:.cc=.o)

REALSRCS = $(REALCORESRCS) $(REALVSSRCS) $(MODULESRCS)

CREATEDFILES = $(CREATEDCOREFILES)


# nothing for just "all";
all:

#
../dp.so: $(COREOBJS)
        $(DYNLD) -o $@ $(COREOBJS)

../libdp.a: $(COREOBJS)
        $(AR) -rc $@ $(COREOBJS) && $(RANLIB) $@

#
pidModule.o: ../modPID-if.cc

../PID.so: ../dp.so pidModule.o
        rm -f dp.so
        ln ../dp.so dp.so
        $(DYNLD) -o $@ pidModule.o dp.so $(LIBS)

../libPID.a: pidModule.o
        $(AR) -rc $@ pidModule.o && $(RANLIB) $@

#
faultModule.o: ../modFault-if.cc

../Fault.so: ../dp.so faultModule.o
        rm -f dp.so
        ln ../dp.so dp.so
        $(DYNLD) -o $@ faultModule.o dp.so $(LIBS)

../libFault.a: faultModule.o
        $(AR) -rc $@ faultModule.o && $(RANLIB) $@

#
dpMiscModule.o: ../modDPMisc-if.cc

../DPMisc.so: ../dp.so dpMiscModule.o
        rm -f dp.so
        ln ../dp.so dp.so
        $(DYNLD) -o $@ dpMiscModule.o dp.so $(LIBS)

../libDPMisc.a: dpMiscModule.o
        $(AR) -rc $@ dpMiscModule.o && $(RANLIB) $@

#
../VirtualSite.so: ../dp.so $(VSOBJS)
        rm -f dp.so
        ln ../dp.so dp.so
        $(DYNLD) -o $@ $(VSOBJS) dp.so $(LIBS)

../libVirtualSite.a: $(VSOBJS)
        $(AR) -rc $@ $(VSOBJS) && $(RANLIB) $@

#
first:  $(CREATEDFILES)

depend:: Makefile $(REALSRCS)
        $(MAKE) first
        $(DEPEND) $(REALSRCS:%=$(SRCDIR)/%) > Makefile.deps

Makefile: Makefile.in
        (cd ..;./config.status)

-include Makefile.deps
include ../Makefile.rules

distclean::
        -rm -f Makefile

veryclean::
        -rm -f *.a *.so Makefile.deps $(CREATEDFILES)

#
# special dependencies...
ALLOBJS=$(COREOBJS) $(VSOBJS) $(MODULEOBJS)
dpMarshaler.hh marshalMsg.cc: msgFormat.m4
$(ALLOBJS): dpMarshaler.hh
