!/bin/sh
# Oz startup script.



# uncomment and adapt the following line if you want
# to draw links from say /usr/local/bin to OZHOME/bin
# see chapter "installation" in the users manual for more information

# OZHOME=/usr/local/oz




######################################################################
# you should not edit below this line

# where Oz resides:

howcalled=$0
cmd=`basename $howcalled`

if test -z "${OZHOME}"
then
  dir=`dirname $howcalled`
  OZHOME=`(cd $dir; cd ..; /bin/pwd)`
fi
export OZHOME

# determine machine architecture and OS version
if test -z "${OZPLATFORM}"
then
  OZPLATFORM=`$OZHOME/bin/ozplatform`
fi
export OZPLATFORM

if test -z "${OZEMULATOR}"
then
    OZEMULATOR=$OZHOME/platform/$OZPLATFORM/oz.emulator.bin
fi


# set OZPATH & PATH
if test -z "${OZ_PI}"
then
  # where Oz searches for files:
  if test -z "${OZPATH}"
  then
     OZPATH=.
  fi
  OZPATH=${OZPATH}:${OZHOME}:${OZHOME}/lib:${OZHOME}/tools:${OZHOME}/platform/${OZPLATFORM}
  export OZPATH
  # increment path
  PATH=${OZHOME}/bin:${OZHOME}/platform/${OZPLATFORM}:${PATH}
  export PATH
  MANPATH=${OZHOME}/man:${MANPATH}
  export MANPATH
  OZ_PI=1
  export OZ_PI
fi

# where is Emacs?
if test "$cmd" = "oz" -a -z "${OZEMACS}"
then

    IFS="${IFS=   }"; saveifs="$IFS"; IFS="$IFS:"
    for name in emacs lemacs xemacs; do
       for dir in $PATH; do
         test -z "$dir" && dir=.
            if test -f $dir/$name; then
            # Not all systems have dirname.
                OZEMACS=$dir/$name
                break 2
            fi
        done
        done
        IFS="$saveifs"
        if test -z "${OZEMACS}"
        then
            echo "Cannot find emacs" 1>&2
            echo "Try setting environment variable OZEMACS" 1>&2
            exit 1
        fi
    fi

    export OZEMACS


case "$cmd" in

   oz)
        echo "Using emacs '${OZEMACS}'"
        # store cmd line args starting from "-a" in $OZARGV
        OZARGV=""
        EMACSARGV=""
        while test $# -gt 0
        do
           case "$1" in
            -a|--)  shift
                 while test $# -gt 0
                 do
                    OZARGV="$OZARGV $1"
                    shift
                 done
            ;;
            *)   EMACSARGV="$EMACSARGV $1"
                 shift
            ;;
           esac
        done
        export OZARGV
        exec  $OZEMACS -l $OZHOME/lib/elisp/oz.elc -f run-oz $EMACSARGV
   ;;

   ozengine)  # that is the real thing
        if test $# -lt 1
        then
            echo "usage: ozengine <url> <args>" 1>&2;
            exit 1;
        fi
        url=$1
        shift
        exec $OZEMULATOR -u $url -a "$@"
   ;;

   *)
       echo "Unknown invocation of Oz via '$cmd'" 1>&2
       exit 1
   ;;
esac
