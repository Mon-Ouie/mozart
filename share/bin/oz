#!/bin/sh
# Script that configures the environment to
# start lemacs for a standalone version of Oz
# MUST reside in <oz dist dir>/bin

#set -vx

# where Oz resides:

howcalled=$0
: ${OZHOME=`dirname \`dirname $howcalled\``}; export OZHOME
echo "Setting Oz installation directory to: $OZHOME"

# determine machine architecture
if [ ${OZARCH-0} = 0 ]; then
  if   [ -f /bin/arch ]; then OZARCH=`/bin/arch`
  elif [ -f /bin/machine ]; then OZARCH=`/bin/machine`
  else echo 1>&2 "error: cannot determine machine type"
       exit 1;
  fi
fi
export OZARCH
: ${OZARCHBIN=$OZHOME/bin/$OZARCH}


# Where ispgm sits:
: ${ISPGM=$OZHOME/bin/ispgm}; export ISPGM


# where Oz searches for files:
: ${OZPATH=.:${OZHOME}:${OZHOME}/lib:${OZHOME}/lib/${OZARCH}:${OZHOME}/demo}; export OZPATH


# increment path
PATH=${PATH}:${OZHOME}/bin; export PATH


# where is lucid emacs?
if [ ${LEMACS-0} = 0 ]; then
  if [ -f ${OZHOME}/lemacs/lemacs ]; then
     LEMACS=${OZHOME}/lemacs/lemacs
  elif [ -f /usr/share/dfki/gnu/bin/lemacs ]; then
     LEMACS=/usr/share/dfki/gnu/bin/lemacs
  else
     LEMACS=lemacs
  fi
fi
export LEMACS


# load fonts
if [ -d ${OZHOME}/lib/fonts ]; then
   xset +fp ${OZHOME}/lib/fonts
fi


# want to use an older version?
if [ ${OZVERSION-0} = 0 ];  then
  PATH=${OZVERSION}:$PATH; export PATH
  OZPATH=${OZVERSION}:$OZPATH; export OZPATH
fi


# setting line editor
ILE=$OZHOME/bin/$OZARCH/ile
if [ ! -f $ILE -o $TERM = emacs ]; then
   ILE=""  # running under emacs
fi


cmd=`basename $howcalled`

case "$cmd" in

   oz)
       exec $LEMACS -l $OZHOME/elisp/ozstartup.el $*
   ;;

   oz.compiler)
       if [ $TERM = "emacs" ]; then
          exec $OZARCHBIN/oz.compiler.bin +E `echo $* |  sed -e 's/-/+/g'`
       else
          exec xterm -name "OzCompiler" \
               -T "Oz Compiler Input Window" \
               -e $ILE $OZARCHBIN/oz.compiler.bin `echo $* |  sed -e 's/-/+/g'`
       fi
   ;;

   oz.machine)
      if [ $TERM = "emacs" ]; then
        exec $OZARCHBIN/oz.machine.bin -E $*
      else
        xterm -title 'Oz Machine' -e $OZARCHBIN/oz.machine.bin $* > /dev/null 2>&1 &
      fi
      exit 0
   ;;

   oz-)
       exec $ILE $OZARCHBIN/oz.compiler.bin $*
   ;;

   *)
       echo "Unknown invocation of Oz via '$cmd'" 1>&2
       exit 1
   ;;
esac
