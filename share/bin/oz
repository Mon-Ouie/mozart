#!/bin/sh
# Script that configures the environment to
# start emacs for a standalone version of Oz
# MUST reside in <oz dist dir>/bin

#set -vx

# where Oz resides:

howcalled=$0
cmd=`basename $howcalled`

if [ ${OZHOME-xx} = xx ]
then
  dir=`dirname $howcalled`
  OZHOME=`(cd $dir; cd ..; /bin/pwd)`
  if [ $cmd != "ozemacs" ]; then
     echo "Setting Oz installation directory to: $OZHOME"
  fi
  export OZHOME
else
  echo "Using Oz directory: $OZHOME"
fi

# determine machine architecture and OS version
: ${OZPLATFORM=`$OZHOME/bin/ozplatform`}
#echo $OZPLATFORM
export OZPLATFORM

setOZC() {
if [ ${OZCOMPILER-xx} = xx ]; then
        OZCOMPILER=$OZHOME/platform/$OZPLATFORM/oz.compiler.bin
else
        echo "Using Oz Compiler: $OZCOMPILER"
fi
}


setOZE() {
if [ ${OZEMULATOR-xx} = xx ]; then
        OZEMULATOR=$OZHOME/platform/$OZPLATFORM/oz.emulator.bin
else
        echo "Using Oz Emulator: $OZEMULATOR"
fi
}

# set OZPATH & PATH
if [ ${OZ_PI-xx} = xx ]; then
        # where Oz searches for files:
        : ${OZPATH=.}
        OZPATH=${OZPATH}:${OZHOME}/lib:${OZHOME}/platform/${OZPLATFORM}:${OZHOME}/demo
        export OZPATH
        #echo "OZPATH = $OZPATH"
        # increment path
        PATH=${OZHOME}/bin:${OZHOME}/platform/${OZPLATFORM}:${PATH}
        export PATH
        #echo "PATH = $PATH"
        OZ_PI=1
        export OZ_PI
fi

# load fonts
if [ -d ${OZHOME}/lib/fonts ]; then
   xset +fp ${OZHOME}/lib/fonts
fi


# setting line editor
: ${OZILE=xxx}
if [ ! -f $OZILE -o $TERM = emacs ]; then
   OZILE=""  # running under emacs
fi


# where is Emacs?
if [ ${OZEMACS-0} = 0 ]; then

  if [ -f ${OZHOME}/ozemacs/bin/$OZPLATFORM/emacs ]; then

    OZEMACS=${OZHOME}/ozemacs/bin/$OZPLATFORM/emacs
    EHOME=$OZHOME/ozemacs
    EMACSLOADPATH=$EHOME/common/lisp:$EHOME/common/site-lisp
    EMACSDATA=$EHOME/common/data
    EMACSDOC=$EMACSDATA
    INFOPATH=$EHOME/info
    EMACSLOCKDIR=$EHOME/common/lock
    EMACSPATH=$EHOME/bin/$OZPLATFORM/etc
    export EMACSLOADPATH EMACSDATA EMACSDOC
    export INFOPATH EMACSLOCKDIR EMACSPATH

  else

     IFS="${IFS=   }"; saveifs="$IFS"; IFS="$IFS:"
     for name in emacs lemacs; do
       for dir in $PATH; do
         test -z "$dir" && dir=.
         if test -f $dir/$name; then
           # Not all systems have dirname.
           OZEMACS=$dir/$name
           break 2
         fi
       done
     done
     IFS="$saveifs"
     if [ ${OZEMACS-0} = 0 ]; then
        echo "Cannot find emacs" 1>&2
        echo "Try setting environment variable OZEMACS" 1>&2
        exit 1
     fi
  fi
fi

export OZEMACS


case "$cmd" in

   oz)
        echo "Using emacs '${OZEMACS}'"
        $OZEMACS -l $OZHOME/lib/elisp/ozstartup.el $@
   ;;

   ozdemo)
        exec $OZHOME/demo/rundemo $@
   ;;

   ozemacs)
        exec $OZEMACS $@
   ;;

   oz.compiler)
        setOZC "$@"
        if [ X$1 = X"-emacs" ]; then
          shift
          exec $OZCOMPILER +E `echo $* |  sed -e 's/-/+/g'`
        else
          exec xterm -name "OzCompiler" \
               -T "Oz Compiler Input Window" \
               -e $OZILE $OZCOMPILER `echo $* |  sed -e 's/-/+/g'`
        fi
   ;;

   oz.emulator)
        setOZE "$@"
        if [ X$1 = X"-emacs" ]; then
                shift
                exec $OZEMULATOR -E "$@"
        else
                xterm -title 'Oz Emulator' -e $OZEMULATOR "$@" \
                        > /dev/null 2>&1 &
        fi
        exit 0
   ;;

   ozsa)  # standalone system
        setOZE "$@"
        exec $OZEMULATOR -E "$@"
   ;;

   oz-)
        setOZC "$@"
        exec $OZILE $OZCOMPILER "$@"
   ;;

   ozc)
        setOZC "$@"
        set -e
        for file in $@; do
            # +p /dev/null --> do not load ~/.ozrc
            $OZCOMPILER +p /dev/null +c $file
        done
        exit $?
   ;;

   ozsac)
        setOZC "$@"
        if [ $# -ne 2 ]; then
           echo "Usage: $0 infile outfile"
           exit 1
        fi
        tempfile=/tmp/ozsac$$
        trap "rm -f $tempfile" 0
        infile=$1; outfile=$2
        $OZCOMPILER +p /dev/null +c $infile +dn $tempfile
        if [ $? -ne 0 ]; then exit 1; fi
        (echo "#!/bin/sh";
         echo ": \${OZHOME=$OZHOME}";
         echo "exec \$OZHOME/bin/ozsa -f \$0";
         echo "###";
         cat $tempfile) > $outfile
        chmod +x $outfile
   ;;

   ozwindowmanager)
        : ${OZWINDOWMANAGER=$OZHOME/unsupported/platform/$OZPLATFORM/ozwindowmanager}
        exec $OZWINDOWMANAGER "$@"
   ;;

   ozdo)
        exec "$@"
   ;;

   *)
       echo "Unknown invocation of Oz via '$cmd'" 1>&2
       exit 1
   ;;
esac
