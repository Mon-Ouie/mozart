#!/bin/sh
# Script that configures the environment to
# start lemacs for a standalone version of Oz
# MUST reside in <oz dist dir>/bin

#set -vx

# where Oz resides:

howcalled=$0

if [ ${OZHOME-xx} = xx ]
then
  OZHOME=`dirname \`dirname $howcalled\``
  echo "Setting Oz installation directory to: $OZHOME"
  export OZHOME
fi

# determine machine architecture and OS version
system="`/bin/uname -m` `/bin/uname -s` `/bin/uname -r`"

case $system in
   sun4*\ SunOS\ 4.1*) OZARCH=sun4
   ;;
   sun4*\ SunOS\ 5*)   OZARCH=sol2
   ;;
   RISC\ ULTRIX\ 4.*)  OZARCH=mips
   ;;
   *)  echo "Cannot determine machine type and OS version" 1>&2 ; exit 1
esac

export OZARCH
#echo "OZARCH = $OZARCH"


: ${OZCOMPILER=$OZHOME/bin/$OZARCH/oz.compiler.bin}
#echo "OZCOMPILER = $OZCOMPILER"

: ${OZMACHINE=$OZHOME/bin/$OZARCH/oz.machine.bin}
#echo "OZMACHINE = $OZMACHINE"

: ${OZWINDOWMANAGER=$OZHOME/bin/$OZARCH/ozwindowmanager}

# set OZPATH & PATH
if [ ${OZ_PI-xx} = xx ]; then

        # where Oz searches for files:
        : ${OZPATH=.}
        OZPATH=${OZPATH}:${OZHOME}/lib:${OZHOME}/lib/${OZARCH}:${OZHOME}/demo
        export OZPATH
#echo "OZPATH = $OZPATH"
        # increment path
        PATH=${OZHOME}/bin:${OZHOME}/bin/${OZARCH}:${PATH}
        export PATH
#echo "PATH = $PATH"
        OZ_PI=1
        export OZ_PI
fi

# load fonts
if [ -d ${OZHOME}/lib/fonts ]; then
   xset +fp ${OZHOME}/lib/fonts
fi


# setting line editor
ILE=$OZHOME/bin/$OZARCH/ile
if [ ! -f $ILE -o $TERM = emacs ]; then
   ILE=""  # running under emacs
fi


cmd=`basename $howcalled`

case "$cmd" in

   oz)
        # where is lucid emacs?
        if [ ${OZEMACS-0} = 0 ]; then
          if [ -f ${OZHOME}/lemacs/lemacs ]; then
             OZEMACS=${OZHOME}/lemacs/lemacs
          else

             IFS="${IFS=   }"; saveifs="$IFS"; IFS="$IFS:"
             for name in lemacs emacs; do
               for dir in $PATH; do
                 test -z "$dir" && dir=.
                 if test -f $dir/$name; then
                   # Not all systems have dirname.
                   OZEMACS=$dir/$name
                   break 2
                 fi
               done
             done
             IFS="$saveifs"
             if [ ${OZEMACS-0} = 0 ]; then
                echo "Cannot find emacs" 1>&2
                echo "Try setting environment variable OZEMACS" 1>&2
                exit 1
             fi
          fi
        fi
        echo "Using emacs '${OZEMACS}'"

        exec $OZEMACS -l $OZHOME/lib/elisp/ozstartup.el "$@"
   ;;

   oz.compiler)

       # make enough room on Prolog heap
       GLOBALSTKSIZE=1000000; export GLOBALSTKSIZE
       if [ $TERM = "emacs" ]; then
          exec $OZCOMPILER +E `echo $* |  sed -e 's/-/+/g'`
       else
          exec xterm -name "OzCompiler" \
               -T "Oz Compiler Input Window" \
               -e $ILE $OZCOMPILER `echo $* |  sed -e 's/-/+/g'`
       fi
   ;;

   oz.machine)


      if [ $TERM = "emacs" ]; then
        exec $OZMACHINE -E "$@"
      else
        xterm -title 'Oz Machine' -e $OZMACHINE "$@" > /dev/null 2>&1 &
      fi
      exit 0
   ;;

   oz-)
        exec $ILE $OZCOMPILER "$@"
   ;;

   ozc)
        set -e
        for file in $@; do
            # +p /dev/null --> do not load ~/.ozrc
            $OZCOMPILER +p /dev/null +c $file
        done
        exit $?
   ;;

   ozwindowmanager)
        exec $OZWINDOWMANAGER "$@"
   ;;

   *)
       echo "Unknown invocation of Oz via '$cmd'" 1>&2
       exit 1
   ;;
esac
