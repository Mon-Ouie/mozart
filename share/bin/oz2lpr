#! /bin/sh
# this file is maintained by CVS in module 'Oz/bin'

# drucke oz dateien aus
# prinzip: oz2tex --> latex --> dvips
# Argumente: -landscape oz-files

DVIPS=dvips
if [ $1 = "-landscape" ]
then
   shift
   DVIPS=dvi2to1p
fi

if [ $# -lt 1 ]; then
  echo "usage: $0 <oz-files>"
  exit 1
fi


cleanup() { rm -f /tmp/$tmpfile* /tmp/$ozfile* /tmp/oz2tex_preamble*; }

trap cleanup 0 1 2 15

tmpfile=oz2lpr-tex-$$
ozfile=oz2lpr-oz-$$

for i in $@
do

if [ "$i" = "-" ]; then    # input from stdin?
   file="stdin"
   cat > /tmp/$ozfile.oz
else
   if [ -f "$i" ]; then
     file=$i
   else
     file=$i.oz
   fi
   if [ ! -f $file ]; then
     echo "file not found: $file"
     continue
  fi

  cp $file /tmp/$ozfile.oz
fi

oz2tex /tmp/$ozfile.oz > /dev/null 2>&1

if [ $? != 0 ]; then
  echo "oz2tex failed: $file"
  continue
fi

cat >> /tmp/$tmpfile.tex << EOF

\documentstyle{article}
\include{oz2tex_preamble}
\pagestyle{empty}

\setlength{\topmargin}{-2cm}

\setlength{\evensidemargin}{-1cm}
\setlength{\oddsidemargin}{-1cm}

\setlength{\textwidth}{18cm}
\setlength{\textheight}{26cm}

\begin{document}
\input{/tmp/$ozfile.tex}
\end{document}

EOF

echo "latex $tmpfile ..."
(cd /tmp; latex $tmpfile > /dev/null < /dev/null)

if [ $? != 0 ]; then
  echo "latex failed: $file"
  egrep '^\!' /tmp/$tmpfile.log
  cleanup
  continue
fi

echo "${DVIPS} $tmpfile ..."
${DVIPS} /tmp/$tmpfile > /dev/null 2>&1
cleanup

done # for
