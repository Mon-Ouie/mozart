BUILDTOP	= @BUILDTOP@
BUILDDIR        = $(BUILDTOP)/share/demo
VPATH		= @srcdir@
SRCDIR		= @srcdir@
SRCTOP		= @SRCTOP@
HOMEURL         = @HOMEURL@

PREFIX		= @prefix@
OZDEMO		= $(PREFIX)/doc/demo/applets

SHELL		= /bin/sh
LN_S            = @LN_S@

INSTALL		= @INSTALL@
INSTALL_FILE	= $(INSTALL) -m 444
INSTALL_DIR	= @INSTALL_DIR@

COMPRESSLEVEL   = @oz_picklecompression@

OZCFLAGS        = 
OZC		= @OZC@

OZLFLAGS        = 
OZL		= @OZL@

COMPILE         = $(OZC) $(OZCFLAGS) -b $(BUILDDIR)/ -c
ZCOMPILE        = $(COMPILE) -z $(COMPRESSLEVEL)

LINK            = $(OZL) $(OZLFLAGS) -z $(COMPRESSLEVEL)

#
# The list of demos
#

APPLETNAMES = \
	JobShop Cutting AnimatedQueens \
	Bounce Trucks Transport Lift \
	Board College DictClient \
	Flowers Flowers3d

APPLETS = \
	$(APPLETNAMES:%=%.oza)

DEMOAPPLETS = \
	$(APPLETS:%=$(OZDEMO)/%)

DIRS = \
	JobShop Cutting Transport DictClient LMF

all: dirs $(APPLETS)

#
# Applet installation
#

install:: $(OZDEMO) $(DEMOAPPLETS)

$(OZDEMO):
	$(INSTALL_DIR) $@

$(OZDEMO)/%.oza: %.oza
	$(INSTALL_FILE) $< $@


#
# Applet compilation
#

# JobShop application
JobShop/%.ozf: JobShop/%.oz
	$(COMPILE) -b $(BUILDDIR)/JobShop/ $< -o $@

JOBSHOP1 = \
	Configure Examples
JOBSHOP2 = \
	Main Scheduler Compiler TaskBoard Tools

JOBSHOPFUN1 = $(JOBSHOP1:%=JobShop/%.ozf)
JOBSHOPFUN2 = $(JOBSHOP2:%=JobShop/%.ozf)

$(JOBSHOPFUN2): $(JOBSHOPFUN1) 

JobShop.oza: $(JOBSHOPFUN2)
	$(LINK) JobShop/Main.ozf -o $@


# JobShop application
Cutting/%.ozf: Cutting/%.oz
	$(COMPILE) -b $(BUILDDIR)/Cutting/ $< -o $@

CUTTING1 = \
	Configure
CUTTING2 = \
	Script Edit Compute Main

CUTTINGFUN1 = $(CUTTING1:%=Cutting/%.ozf)
CUTTINGFUN2 = $(CUTTING2:%=Cutting/%.ozf)

$(CUTTINGFUN2): $(CUTTINGFUN1) 

Cutting.oza: $(CUTTINGFUN2)
	$(LINK) Cutting/Main.ozf -o $@


# Transport application
Transport/%.ozf: Transport/%.oz
	$(COMPILE)  -b $(BUILDDIR)/Transport/ $< -o $@

TRANSPORT = \
	AgentAbstractions Agents Configure Country \
	Dialogs Germany Main Plan \
	Randomizer Widgets
TRANSPORTFUN = $(TRANSPORT:%=Transport/%.ozf)

Transport/Country.ozf: Transport/Germany.oz

Transport.oza: $(TRANSPORTFUN)
	$(LINK) Transport/Main.ozf -o $@

# Dict Client application
DictClient/%.ozf: DictClient/%.oz
	$(COMPILE) -b $(BUILDDIR)/DictClient/ $< -o $@

DICTCLIENT = Main NetDictionary TkDictionary
DICTCLIENTFUN = $(DICTCLIENT:%=DictClient/%.ozf)

DictClient.oza: $(DICTCLIENTFUN)
	$(LINK) DictClient/Main.ozf -o $@


DemoUrls.ozf: DemoUrls.oz
	$(ZCOMPILE) $< -o $@

%.ozf: DemoUrls.ozf

$(APPLETS) Transport/Configure.ozf DictClient/TkDictionary.ozf: DemoUrls.ozf

%.oza: %.oz
	$(ZCOMPILE) $< -o $@

%.ozf: %.oz
	$(COMPILE) $< -o $@

# Last Minute Flights

LMF/%.ozf: LMF/%.oz
	$(COMPILE) -b $(BUILDDIR)/LMF/ $< -o $@

LMF1 = \
	Abstractions HTML Server Book ProcessBook

LMFFUN = $(LMF1:%=LMF/%.ozf)

lmf-server: $(LMFFUN)
	$(LINK) -x LMF/Server.ozf -o $@

lmf-book.cgi: $(LMFFUN)
	$(LINK) -x LMF/Book.ozf -o $@

lmf-process.cgi: $(LMFFUN)
	$(LINK) -x LMF/ProcessBook.ozf -o $@

.PHONY: lmf

lmf: lmf-server lmf-book.cgi lmf-process.cgi

#
# Images
#

OZIMG = $(OZDEMO)/images

IMGDIRS = \
	animated-queens diagnosis lift transport trucks college dict-client

OZIMGDIRS = $(IMGDIRS:%=$(OZIMG)/%)

QUEENSIMGS0 = \
	large-cross large-gray large-queen large-solid \
	micro-gray micro-queen micro-solid \
	middle-cross middle-gray middle-queen middle-solid \
	small-gray small-queen small-solid \
	tiny-gray tiny-queen tiny-solid

DIAGIMGS0 = \
	and or xor

LIFTIMGS0 = \
	downE downF lift liftDown liftUp upE upF

TRANSPORTIMGS0 = \
	down \
	truck_fill_left truck_fill_right \
	truck_frame_left truck_frame_right \
	truck_win_left truck_win_right

TRUCKSIMGS0 = \
	truck-left truck-right

COLLEGEIMGS0 = \
	title

DICTCLIENTIMGS0 = \
	dict

OZIMAGES = \
	$(QUEENSIMGS0:%=$(OZIMG)/animated-queens/%.xbm) \
	$(DIAGIMGS0:%=$(OZIMG)/diagnosis/%.xbm) \
	$(LIFTIMGS0:%=$(OZIMG)/lift/%.xbm) \
	$(TRANSPORTIMGS0:%=$(OZIMG)/transport/%.xbm) \
	$(TRUCKSIMGS0:%=$(OZIMG)/trucks/%.ppm) \
	$(COLLEGEIMGS0:%=$(OZIMG)/college/%.xbm) \
	$(DICTCLIENTIMGS0:%=$(OZIMG)/dict-client/%.gif)


install:: $(OZIMGDIRS) $(OZIMAGES)

$(OZIMGDIRS):
	$(INSTALL_DIR) $@
$(OZIMG)/animated-queens/%.xbm: images/animated-queens/%.xbm
	$(INSTALL_FILE) $< $@
$(OZIMG)/diagnosis/%.xbm: images/diagnosis/%.xbm
	$(INSTALL_FILE) $< $@
$(OZIMG)/lift/%.xbm: images/lift/%.xbm
	$(INSTALL_FILE) $< $@
$(OZIMG)/transport/%.xbm: images/transport/%.xbm
	$(INSTALL_FILE) $< $@
$(OZIMG)/trucks/%.ppm: images/trucks/%.ppm
	$(INSTALL_FILE) $< $@
$(OZIMG)/college/%.xbm: images/college/%.xbm
	$(INSTALL_FILE) $< $@
$(OZIMG)/dict-client/%: images/dict-client/%
	$(INSTALL_FILE) $< $@


#
# Generic
#
.PHONY: check depend bootstrap clean veryclean distclean

clean::
	-rm -f *~ ./*/*~ ./*/*/*~ *.ozf ./*/*.ozf

veryclean:: clean
	-rm -f *.oza

distclean: veryclean
	-rm -f Makefile config.cache config.status config.log

Makefile: Makefile.in ../config.status
	cd .. && ./config.status

../config.status: ../configure
	cd .. && ./config.status --recheck

include $(SRCDIR)/../Makefile.boot

dirs:
	dirs="$(DIRS)"; \
	for d in $$dirs; \
	do if test ! -d $$d; then mkdir $$d; fi; \
	done

bootstrap: dirs
	$(MAKE) boot-all

check:

depend:
