BUILDTOP	= @BUILDTOP@
VPATH		= @srcdir@
SRCDIR		= @srcdir@
TOPDIR		= @TOPDIR@

PREFIX		= @prefix@
OZDEMO		= $(PREFIX)/demo

SHELL		= @SH@
RM		= @RM@ -f
MKDIR		= @MKDIR@
ECHO		= @ECHO@
M4		= @M4@
LN              = @LN_S@

INSTALL		= @INSTALL@
INSTALLFILE	= $(INSTALL) -m 444
INSTALLSRC	= @INSTALLSRC@
INSTALLDIR	= $(INSTALL) -m 775 -d

OZBATCH		= @OZBATCH@
OZCA		= $(OZBATCH) -l AP,OP


#
# The list of demos
#

DIRS = \
	concurrent constraints distributed

CONSTRAINTS = \
	job-shop animated-queens

CONCURRENT = \
	bounce trucks transport lift

DISTRIBUTED = \
	board

all::

OZDIRS = $(DIRS:%=$(OZDEMO)/%)

install:: $(OZDEMO) $(OZDIRS)
	
$(OZDEMO):
	$(INSTALLDIR) $@

$(OZDIRS):
	$(INSTALLDIR) $@
	$(LN) $@/../demo.css $@
	$(LN) $@/../demo.gif $@

#
# Web pages
# 

CONSTRAINTWEB  = $(CONSTRAINTS:%=constraints/%.html)
CONCURRENTWEB  = $(CONCURRENT:%=concurrent/%.html)
DISTRIBUTEDWEB = $(DISTRIBUTED:%=distributed/%.html)

WEBPAGES = \
	$(CONSTRAINTWEB) $(CONCURRENTWEB) $(DISTRIBUTEDWEB)

CONSTRAINTWEBC  = $(CONSTRAINTS:%=constraints/%-html.ozc)
CONCURRENTWEBC  = $(CONCURRENT:%=concurrent/%-html.ozc)
DISTRIBUTEDWEBC = $(DISTRIBUTED:%=distributed/%-html.ozc)

WEBC = \
	$(CONSTRAINTWEBC) $(CONCURRENTWEBC) $(DISTRIBUTEDWEBC)

all:: $(WEBPAGES) $(WEBC)

ozc2html: make-ozc2html.oz
	$(OZCA) make-ozc2html.oz	

$(WEBPAGES): ozc2html

constraints/%.html: constraints/%-html.ozc
	./ozc2html --ozc=$< > $@
concurrent/%.html: concurrent/%-html.ozc
	./ozc2html --ozc=$< > $@
distributed/%.html: distributed/%-html.ozc
	./ozc2html --ozc=$< > $@

constraints/%-html.ozc: constraints/%-html.oz
	$(OZCA) -c $< -o $@
concurrent/%-html.ozc: concurrent/%-html.oz
	$(OZCA) -c $< -o $@
distributed/%-html.ozc: distributed/%-html.oz
	$(OZCA) -c $< -o $@

clean:: 
	$(RM) $(WEBC) ozc2html

veryclean::
	$(RM) $(WEBPAGES)


ALLWEB = \
	$(WEBPAGES) \
	demo.css demo.gif \
	index.html \
	install.html netscape.gif

OZALLWEB = $(ALLWEB:%=$(OZDEMO)/%)

install:: $(OZALLWEB)

$(OZDEMO)/%.html: %.html
	$(INSTALLFILE) $< $@
$(OZDEMO)/%.css: %.css
	$(INSTALLFILE) $< $@
$(OZDEMO)/%.gif: %.gif
	$(INSTALLFILE) $< $@

$(OZDEMO)/constraints/%.html: constraints/%.html
	$(INSTALLFILE) $< $@
$(OZDEMO)/concurrent/%.html: concurrent/%.html
	$(INSTALLFILE) $< $@
$(OZDEMO)/distributed/%.html: distributed/%.html
	$(INSTALLFILE) $< $@

#
# Compiling the applets
#

CONSTRAINTAPPLETS  = $(CONSTRAINTS:%=constraints/%.oza)
CONCURRENTAPPLETS  = $(CONCURRENT:%=concurrent/%.oza)
DISTRIBUTEDAPPLETS = $(DISTRIBUTED:%=distributed/%.oza)

APPLETS = \
	$(CONSTRAINTAPPLETS) \
	$(CONCURRENTAPPLETS) \
	$(DISTRIBUTEDAPPLETS)

all:: $(APPLETS)

constraints/%.oza: constraints/%.oz
	(cd constraints && $(OZCA) ../$<)
concurrent/%.oza: concurrent/%.oz
	(cd concurrent && $(OZCA) ../$<)
distributed/%.oza: distributed/%.oz
	(cd distributed && $(OZCA) ../$<)

JOBSHOP = \
	compiler configure duration-tool examples job \
	main resource-tool scheduler task-board task tools
constraints/job-shop.oza: $(JOBSHOP:%=constraints/job-shop/%.oz)

TRANSPORT = \
	agent broker company configure contract \
	country driver environment frontend germany \
	makeplan randomizer truck widgets
concurrent/transport.oza: $(TRANSPORT:%=concurrent/transport/%.oz)


veryclean::
	$(RM) $(APPLETS)

OZAPPLETS = $(APPLETS:%=$(OZDEMO)/%)

install:: $(OZAPPLETS)
	
$(OZDEMO)/constraints/%.oza: constraints/%.oza
	$(INSTALLFILE) $< $@
$(OZDEMO)/concurrent/%.oza: concurrent/%.oza
	$(INSTALLFILE) $< $@
$(OZDEMO)/distributed/%.oza: distributed/%.oza
	$(INSTALLFILE) $< $@


#
# Images
#

OZIMG = $(OZDEMO)/images

IMGDIRS = \
	animated-queens diagnosis lift transport trucks

OZIMGDIRS = $(IMGDIRS:%=$(OZIMG)/%)

QUEENSIMGS0 = \
	large-cross large-gray large-queen large-solid \
	micro-gray micro-queen micro-solid \
	middle-cross middle-gray middle-queen middle-solid \
	small-gray small-queen small-solid \
	tiny-gray tiny-queen tiny-solid

DIAGIMGS0 = \
	and or xor

LIFTIMGS0 = \
	downE downF lift liftDown liftUp upE upF

TRANSPORTIMGS0 = \
	down \
	truck_fill_left truck_fill_right \
	truck_frame_left truck_frame_right \
	truck_win_left truck_win_right

TRUCKSIMGS0 = \
	truck-left truck-right

OZIMAGES = \
	$(QUEENSIMGS0:%=$(OZIMG)/animated-queens/%.xbm) \
	$(DIAGIMGS0:%=$(OZIMG)/diagnosis/%.xbm) \
	$(LIFTIMGS0:%=$(OZIMG)/lift/%.xbm) \
	$(TRANSPORTIMGS0:%=$(OZIMG)/transport/%.xbm) \
	$(TRUCKSIMGS0:%=$(OZIMG)/trucks/%.gif)

install:: $(OZIMGDIRS) $(OZIMAGES)

$(OZIMGDIRS):
	$(INSTALLDIR) $@
	
$(OZIMG)/animated-queens/%.xbm: images/animated-queens/%.xbm
	$(INSTALLSRC) $< $@
$(OZIMG)/diagnosis/%.xbm: images/diagnosis/%.xbm
	$(INSTALLSRC) $< $@
$(OZIMG)/lift/%.xbm: images/lift/%.xbm
	$(INSTALLSRC) $< $@
$(OZIMG)/transport/%.xbm: images/transport/%.xbm
	$(INSTALLSRC) $< $@
$(OZIMG)/trucks/%.gif: images/trucks/%.gif
	$(INSTALLFILE) $< $@


#
# Generic
#

clean::
	$(RM) *~ ./*/*~ ./*/*/*~

veryclean:: clean

realclean: veryclean

