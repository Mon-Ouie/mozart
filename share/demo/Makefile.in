BUILDTOP	= @BUILDTOP@
VPATH		= @srcdir@
SRCDIR		= @srcdir@
SRCTOP		= @SRCTOP@

PREFIX		= @prefix@
OZDEMO		= $(PREFIX)/doc/demo

SHELL		= /bin/sh
LN_S            = @LN_S@

INSTALL		= @INSTALL@
INSTALL_FILE	= $(INSTALL) -m 444
INSTALL_DIR	= @INSTALL_DIR@

COMPRESSLEVEL   = @oz_picklecompression@

OZCFLAGS        = 
OZC		= @OZC@

OZLFLAGS        = 
OZL		= @OZL@

COMPILE         = $(OZC) $(OZCFLAGS) -c
ZCOMPILE        = $(OZC) $(OZCFLAGS) -z $(COMPRESSLEVEL) -c

LINK            = $(OZL) $(OZLFLAGS) -z $(COMPRESSLEVEL)

#
# The list of demos
#

APPLETNAMES = \
	JobShop AnimatedQueens \
	Bounce Trucks Transport Lift \
	Board

APPLETS = \
	$(APPLETNAMES:%=%.oza)

DEMOAPPLETS = \
	$(APPLETS:%=$(OZDEMO)/%)


all:: $(APPLETS)

#
# Applet installation
#

install:: $(OZDEMO) $(DEMOAPPLETS)

$(OZDEMO):
	$(INSTALL_DIR) $@

$(OZDEMO)/%.oza: %.oza
	$(INSTALL_FILE) $< $@


#
# Applet compilation
#

all:: $(APPLETS)

%.oza: %.oz
	$(ZCOMPILE) $< -o $@

%.oza: %.ozf
	$(COMPILE) $< -o $@


# JobShop application
JobShop/%.ozf: JobShop/%.oz
	$(COMPILE) -b $(SRCDIR)/JobShop/ $< -o $@

JOBSHOP1 = \
	Configure Examples
JOBSHOP2 = \
	JobShop Scheduler Compiler TaskBoard Tools

JOBSHOPFUN1 = $(JOBSHOP1:%=JobShop/%.ozf)
JOBSHOPFUN2 = $(JOBSHOP2:%=JobShop/%.ozf)

$(JOBSHOPFUN2): $(JOBSHOPFUN1) 

JobShop.oza: $(JOBSHOPFUN2)
	$(LINK) JobShop/JobShop.ozf -o $@


TRANSPORT = \
	agent broker company configure contract \
	country driver environment frontend germany \
	makeplan randomizer truck widgets
Transport.oza: $(TRANSPORT:%=Transport/%.oz)




#
# Images
#

OZIMG = $(OZDEMO)/images

IMGDIRS = \
	animated-queens diagnosis lift transport trucks

OZIMGDIRS = $(IMGDIRS:%=$(OZIMG)/%)

QUEENSIMGS0 = \
	large-cross large-gray large-queen large-solid \
	micro-gray micro-queen micro-solid \
	middle-cross middle-gray middle-queen middle-solid \
	small-gray small-queen small-solid \
	tiny-gray tiny-queen tiny-solid

DIAGIMGS0 = \
	and or xor

LIFTIMGS0 = \
	downE downF lift liftDown liftUp upE upF

TRANSPORTIMGS0 = \
	down \
	truck_fill_left truck_fill_right \
	truck_frame_left truck_frame_right \
	truck_win_left truck_win_right

TRUCKSIMGS0 = \
	truck-left truck-right

OZIMAGES = \
	$(QUEENSIMGS0:%=$(OZIMG)/animated-queens/%.xbm) \
	$(DIAGIMGS0:%=$(OZIMG)/diagnosis/%.xbm) \
	$(LIFTIMGS0:%=$(OZIMG)/lift/%.xbm) \
	$(TRANSPORTIMGS0:%=$(OZIMG)/transport/%.xbm) \
	$(TRUCKSIMGS0:%=$(OZIMG)/trucks/%.gif)

install:: $(OZIMGDIRS) $(OZIMAGES)

$(OZIMGDIRS):
	$(INSTALL_DIR) $@
$(OZIMG)/animated-queens/%.xbm: images/animated-queens/%.xbm
	$(INSTALL_FILE) $< $@
$(OZIMG)/diagnosis/%.xbm: images/diagnosis/%.xbm
	$(INSTALL_FILE) $< $@
$(OZIMG)/lift/%.xbm: images/lift/%.xbm
	$(INSTALL_FILE) $< $@
$(OZIMG)/transport/%.xbm: images/transport/%.xbm
	$(INSTALL_FILE) $< $@
$(OZIMG)/trucks/%.gif: images/trucks/%.gif
	$(INSTALL_FILE) $< $@


#
# Generic
#
.PHONY: check depend bootstrap clean veryclean distclean

clean::
	-rm -f *~ ./*/*~ ./*/*/*~ *.ozf

veryclean:: clean
	-rm -f *.oza

distclean: veryclean
	-rm -f Makefile config.cache config.status config.log

Makefile: Makefile.in ../config.status
	cd .. && ./config.status

../config.status: ../configure
	cd .. && ./config.status --recheck

include $(SRCDIR)/../Makefile.boot

dirs:
	dirs="$(DIRS)"; \
	for d in $$dirs; \
	do if test ! -d $$d; then mkdir $$d; fi; \
	done

bootstrap: dirs
	$(MAKE) boot-all

check:

depend:
