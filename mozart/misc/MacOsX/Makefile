#
#  Authors:
#    Gustavo Gutierrez <ggutierrez@cic.puj.edu.co>
#
#  Contributors:
#    Raphael Collet <raphael.collet@uclouvain.be>
#
#  Copyright:
#    Gustavo Gutierrez, 2008
#
#  Last change:
#    $Date$ by $Author$
#    $Revision$
# 
#  This file is part of Mozart, an implementation 
#  of Oz 3:
#     http://www.mozart-oz.org
# 
#  See the file "LICENSE" or
#     http://www.mozart-oz.org/LICENSE.html
#  for information on usage and redistribution 
#  of this file, and for a DISCLAIMER OF ALL 
#  WARRANTIES.
#


# Makefile to package the a Mozart distribution for Mac OS X as a bundle 
# inside a disk image.


###
# Variables for external tools and directories.
###

# Platpus commanline tool
PLAT=/usr/local/bin/platypus 

## Cocoa dialog
CD=/Users/gg/Desktop/CocoaDialog.app

##
# Mozart Installation
##
MOZ_INST=/Users/gg/Work/mg

## Mozart documentation
MOZ_DOC=/Users/gg/Desktop/Documentation

##----------------------------------------------------------------
## Do not modify anything bellow this line

## Directories of mozart installation to be bundled.
MOZ_DIRS= platform bin cache share include

VERSION := $(shell $(MOZ_INST)/bin/oztool version)
PLATFORM := $(shell $(MOZ_INST)/bin/ozplatform)
DATE := $(shell date +%d%h%y)
NAME := Mozart
APP := $(NAME).app

## Directories inside the bundle
BND_CONTENTS := $(APP)/Contents

## The Resources directory is where mozart installation files will be.
BND_RESOURCES := $(BND_CONTENTS)/Resources

## The Frameworks directory is where shared libraries used by the emulator 
## will be placed. For instance, libgmp.dylib

BND_FRAMEWORKS := $(BND_CONTENTS)/Frameworks


## The path to the emulator inside the bundle
PLATFORM := $(shell $(MOZ_INST)/bin/oztool platform)
EMULATOR := $(BND_RESOURCES)/platform/$(PLATFORM)/emulator.exe

## Platypus call
PLATCALL = $(PLAT) -D -X "oz|OZ" -V "1.5.0" -u 'Gustavo Gutierrez <ggutierrez@cic.puj.edu.co>' -i 'appIcon.icns' script.sh ./$(APP)

##
#Create a bundle from skel
##
all: bundle fixpaths

bundle:
	rm -rf $(APP)
	$(PLATCALL)
	for i in $(MOZ_DIRS); do  \
		cp -R $(MOZ_INST)/$$i $(BND_RESOURCES); \
	done
	cp -R $(CD) $(BND_RESOURCES)
	mkdir -p $(BND_FRAMEWORKS)/


fixpaths:
	python ./bundlelibs.py $(PLATFORM)


diskimage:
	-rm -rf tmpdir
	mkdir -p tmpdir/
	mv Mozart.app tmpdir/
	cp -r $(MOZ_DOC) tmpdir/
	cp -r $(MOZ_INST)/examples tmpdir/
	./make-dmg.sh $(NAME)-$(VERSION)-$(DATE).dmg tmpdir/ $(NAME)
	-rm -rf tmpdir
	@echo finished


.PHONY: bundskel fixpaths

clean:
	-rm -rf $(APP)
